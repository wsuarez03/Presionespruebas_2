<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verificaci√≥n De Presiones</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-color: #f9f9f9;
      color: #333;
    }
    .titulo { text-align: left; }
    @media (max-width: 600px) { .titulo { text-align: center; } .fila-doble { flex-direction: column; } }
    input, select {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
      background-color: #fff;
    }
    .fila-doble { display: flex; gap: 10px; margin-bottom: 15px; }
    .columna { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    #resultado {
      font-weight: bold;
      font-size: 1.05em;
      margin-top: 18px;
      color: #333;
      white-space: pre-line;
    }
    .logo { display: block; margin: 0 auto 20px; max-width: 250px; height: auto; }
  </style>
</head>

<body>
  <img src="LOGO VALSER.png" alt="Logo" class="logo">
  <h1 class="titulo">PRUEBAS DE PRESIONES</h1>

  <input type="text" id="Client_Proy" placeholder="Cliente/Proyecto">

  <div class="fila-doble">
    <div class="columna">
      <input type="text" id="Tag" placeholder="Tag/Serial">
      <select id="sel_prueb">
        <option value="" disabled selected>Tipo de prueba</option>
        <option value="Banco">Banco</option>
        <option value="VST 2">VST 2</option>
        <option value="VST 3">VST 3</option>
      </select>

      <select id="manometro" style="display:none;">
        <option value="" disabled selected>Man√≥metro</option>
        <option value="MAN-002">MAN-002 (Crystal 5k)</option>
        <option value="MAN-003">MAN-003 (Additel)</option>
        <option value="MAN-005">MAN-005 (Crystal 1k)</option>
        <option value="MAN-006">MAN-006 (Wika)</option>
      </select>

      <select id="transmisor" style="display:none;">
        <option value="" disabled selected>Transmisor</option>
        <option value="TP-002">TP-002 (5000 psi)</option>
        <option value="TP-004">TP-004 (145 psi)</option>
        <option value="TP-008">TP-008 (870 psi)</option>
        <option value="TP-009">TP-009 (3625 psi)</option>
        <option value="TP-010">TP-010 (1000 psi)</option>
      </select>

      <input type="number" id="diametro_ext" placeholder="Di√°metro externo" style="display:none;">
      <input type="number" id="pres_caldera" placeholder="Presi√≥n de caldera" style="display:none;">
    </div>

    <div class="columna">
      <select id="sel_seccion">
        <option value="" disabled selected>Secci√≥n v√°lvula</option>
        <option value="Sec. I">Sec. I</option>
        <option value="Sec. VIII">Sec. VIII</option>
      </select>
      <input type="number" id="set" placeholder="Set de presi√≥n v√°lvula">
      <select id="celdas" style="display:none;">
        <option value="" disabled selected>Celda de carga</option>
        <option value="CEC-001">CEC-001 (0.5 T)</option>
        <option value="CEC-003">CEC-003 (2 T)</option>
        <option value="CEC-004">CEC-004 (1 T)</option>
        <option value="CEC-005">CEC-005 (1 T)</option>
        <option value="CEC-006">CEC-006 (2 T)</option>
        <option value="CEC-007">CEC-007 (5 T)</option>
      </select>
      <input type="number" id="diametro_int" placeholder="Di√°metro interno" style="display:none;">
    </div>
  </div>

  <input type="number" id="p1" placeholder="Escape 1 (PSI)">
  <input type="number" id="p2" placeholder="Escape 2 (PSI)">
  <input type="number" id="p3" placeholder="Escape 3 (PSI)">
  <input type="number" id="p4" placeholder="Escape 4 (PSI)">

  <button onclick="validar()">‚úÖ Verificar</button>
  <button onclick="enviarCorreo()">üì§ Enviar pruebas aprobadas</button>

  <div id="resultado"></div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

  <script>
    // =========================
    // FUNCIONES AUXILIARES
    // =========================
    function tInvNumeric(prob, df, tol = 1e-12, maxIter = 200) {
      if (!(prob > 0 && prob < 1) || df <= 0) return NaN;
      if (typeof jStat !== "undefined" && typeof jStat.studentt.inv === "function") return jStat.studentt.inv(prob, df);
      const sign = prob < 0.5 ? -1 : 1;
      const target = prob < 0.5 ? 1 - prob : prob;
      let lo = 0, hi = 1;
      while (jStat.studentt.cdf(hi, df) < target) hi *= 2;
      for (let i=0;i<maxIter;i++){ const mid=(lo+hi)/2; const cdfMid=jStat.studentt.cdf(mid, df); if(Math.abs(cdfMid-target)<tol) return sign*mid; if(cdfMid<target) lo=mid; else hi=mid; }
      return sign*(lo+hi)/2;
    }

    function desviacionEstandar(valores){
      const n = valores.length;
      if(n<2) return 0;
      const mean = valores.reduce((a,b)=>a+b,0)/n;
      const variance = valores.reduce((sum,x)=>sum+Math.pow(x-mean,2),0)/(n-1);
      return Math.sqrt(variance);
    }

    const MANOMETER_DATA = {
      "MAN-002": {resolucion:0.1, deriva:0.59, u_interp:0.162163468825291, certificado:0.38, factor_cert:1.97, divisor_interp:6},
      "MAN-003": {resolucion:0.1, deriva:0.35, u_interp:0.75, certificado:0.35, factor_cert:1.97, divisor_interp:10},
      "MAN-005": {resolucion:0.1, deriva:0.092, u_interp:0.0169880966040896, certificado:0.092, factor_cert:2, divisor_interp:10}
    };

    const OPERATOR_DATA = [65.08,65.28,65.08,65.01,65.16,65.19,65.34,65.16,64.86,64.7,65.1,65.23,65.16,65.06,64.96];

    // Datos de transmisor (Presi√≥n indicada)
    const TRANSMISOR_DATA = {
      "TP-010": {resolucion:0.01, deriva:0.72, u_interp:0.292808052203206, certificado:0.72, factor_cert:2, modelo:"VST3", presion_range:"1000 psi"},
      "TP-002": {resolucion:0.01, deriva:1.4, u_interp:0.967846419901973, certificado:1.4, factor_cert:2, modelo:"VST3", presion_range:"5000 psi"},
      "TP-004": {resolucion:0.01, deriva:0.05, u_interp:0.0147761347706818, certificado:0.048, factor_cert:2, modelo:"VST3", presion_range:"145 psi"},
      "TP-008": {resolucion:0.01, deriva:0.1, u_interp:0.0401484588381262, certificado:0.07, factor_cert:2, modelo:"VST2", presion_range:"870 psi"},
      "TP-009": {resolucion:0.01, deriva:0.81, u_interp:0.520987754949661, certificado:0.81, factor_cert:2, modelo:"VST2", presion_range:"3625 psi"}
    };

    // Datos de celda de carga (Fuerza/Presi√≥n generada)
    const CELDA_DATA = {
      "CEC-001": {resolucion:0.0004, u_interp:0.00120499518150945, certificado:0.0004, factor_cert:2, modelo:"VST3", capacidad:"0.5T"},
      "CEC-004": {resolucion:0.001, u_interp:0.00733851478857701, certificado:0.001, factor_cert:2, modelo:"VST3", capacidad:"1T"},
      "CEC-003": {resolucion:0.001, u_interp:0.0234029276640666, certificado:0.001, factor_cert:2, modelo:"VST3", capacidad:"2T"},
      "CEC-005": {resolucion:0.001, u_interp:0.024671976476918, certificado:0.001, factor_cert:2, modelo:"VST2", capacidad:"1T"},
      "CEC-006": {resolucion:0.001, u_interp:0.0223125119839804, certificado:0.001, factor_cert:2, modelo:"VST2", capacidad:"2T"},
      "CEC-007": {resolucion:0.04, u_interp:0.0538769501113177, certificado:0.04, factor_cert:2, modelo:"VST2", capacidad:"5T"}
    };

    document.addEventListener('DOMContentLoaded', () => {
      const selPrueba=document.getElementById("sel_prueb");
      const manometro=document.getElementById("manometro");
      const transmisor=document.getElementById("transmisor");
      const celdas=document.getElementById("celdas");
      const diametro_ext=document.getElementById("diametro_ext");
      const diametro_int=document.getElementById("diametro_int");
      const pres_caldera=document.getElementById("pres_caldera");
      const p4=document.getElementById("p4");

      selPrueba.addEventListener("change", () => {
        const tipo=selPrueba.value;
        if(["VST 2","VST 3"].includes(tipo)){ p4.style.display="none"; p4.value=""; } else { p4.style.display="block"; }
        if(tipo==="Banco"){ manometro.style.display="block"; transmisor.style.display="none"; transmisor.value=""; celdas.style.display="none"; celdas.value=""; diametro_ext.style.display="none"; diametro_ext.value=""; diametro_int.style.display="none"; diametro_int.value=""; pres_caldera.style.display="none"; pres_caldera.value=""; }
        if(["VST 2","VST 3"].includes(tipo)){ manometro.style.display="none"; manometro.value=""; transmisor.style.display="block"; celdas.style.display="block"; diametro_ext.style.display="block"; diametro_int.style.display="block"; pres_caldera.style.display="block"; filtrarTransmisoresYCeldas(tipo); }
      });

      function filtrarTransmisoresYCeldas(tipo){
        const opcionesTrans={"VST 2":["TP-008","TP-009"],"VST 3":["TP-002","TP-004","TP-010"]};
        const opcionesCeldas={"VST 2":["CEC-005","CEC-006","CEC-007"],"VST 3":["CEC-001","CEC-004","CEC-003"]};
        [...transmisor.options].forEach(opt=>{if(opt.value==="")return; opt.disabled=!opcionesTrans[tipo].includes(opt.value); opt.style.display=opt.disabled?"none":"block";});
        [...celdas.options].forEach(opt=>{if(opt.value==="")return; opt.disabled=!opcionesCeldas[tipo].includes(opt.value); opt.style.display=opt.disabled?"none":"block";});
        transmisor.value=""; celdas.value="";
      }
    });

    try{ emailjs.init("tlcM6igKsBWhU-7x1"); }catch(e){console.warn("EmailJS init fall√≥:",e); }

    function mostrarMensaje(msg){ document.getElementById("resultado").innerText=msg; }

    function validar(){
      mostrarMensaje("");
      let U=null; let mensajeIncert="";
      const client_proy=document.getElementById("Client_Proy").value.trim();
      const tag=document.getElementById("Tag").value.trim();
      const set=parseFloat(document.getElementById("set").value);
      const seccion=document.getElementById("sel_seccion").value;
      const tipo=document.getElementById("sel_prueb").value;
      const manometro=document.getElementById("manometro").value;
      const transmisor=document.getElementById("transmisor").value;
      const celdas=document.getElementById("celdas").value;
      const diametro_ext=parseFloat(document.getElementById("diametro_ext").value);
      const diametro_int=parseFloat(document.getElementById("diametro_int").value);
      const pres_caldera=parseFloat(document.getElementById("pres_caldera").value);
      const p1=parseFloat(document.getElementById("p1").value);
      const p2=parseFloat(document.getElementById("p2").value);
      const p3=parseFloat(document.getElementById("p3").value);
      const p4_val=parseFloat(document.getElementById("p4").value);

      if(isNaN(set)) return mostrarMensaje("‚ö†Ô∏è Falta set de presi√≥n v√°lvula.");
      if(!tipo) return mostrarMensaje("‚ö†Ô∏è Debes seleccionar tipo de prueba.");
      if(!seccion) return mostrarMensaje("‚ö†Ô∏è Debes seleccionar la secci√≥n.");
      if(tipo==="Banco" && !manometro) return mostrarMensaje("‚ö†Ô∏è Debes seleccionar man√≥metro.");
      if(["VST 2","VST 3"].includes(tipo) && !transmisor) return mostrarMensaje("‚ö†Ô∏è Debes seleccionar transmisor.");
      if(["VST 2","VST 3"].includes(tipo) && !celdas) return mostrarMensaje("‚ö†Ô∏è Debes seleccionar celda de carga.");
      if(["VST 2","VST 3"].includes(tipo) && isNaN(diametro_ext)) return mostrarMensaje("‚ö†Ô∏è Falta diametro externo.");
      if(["VST 2","VST 3"].includes(tipo) && isNaN(diametro_int)) return mostrarMensaje("‚ö†Ô∏è Falta diametro interno.");
      if(["VST 2","VST 3"].includes(tipo) && isNaN(pres_caldera)) return mostrarMensaje("‚ö†Ô∏è Falta presi√≥n de caldera.");

      let presiones=[{nombre:"Escape 1",valor:p1},{nombre:"Escape 2",valor:p2},{nombre:"Escape 3",valor:p3}];
      if(tipo==="Banco") presiones.push({nombre:"Escape 4",valor:p4_val});
      if(presiones.some(p=>isNaN(p.valor))) return mostrarMensaje(`‚ö†Ô∏è Faltan presiones para ${tipo}`);

      const promedio=presiones.reduce((acc,p)=>acc+p.valor,0)/presiones.length;
      const deltaRep=promedio>50?promedio*0.01:0.5;
      const infRep=promedio-deltaRep;
      const supRep=promedio+deltaRep;
      const erroresRep=presiones.filter(p=>p.valor<infRep||p.valor>supRep).map(p=>`${p.nombre}: ${p.valor} PSI fuera del rango de repetibilidad`);

      let deltaSeccion=0;
      if(seccion==="Sec. I"){ if(set<=70) deltaSeccion=2; else if(set<=300) deltaSeccion=set*0.03; else if(set<=1000) deltaSeccion=10; else deltaSeccion=set*0.01; }
      else if(seccion==="Sec. VIII") deltaSeccion=set<=70?2:set*0.03;

      const infSeccion=set-deltaSeccion;
      const supSeccion=set+deltaSeccion;
      const erroresSec=presiones.filter(p=>p.valor<infSeccion||p.valor>supSeccion).map(p=>`${p.nombre}: ${p.valor} PSI fuera del rango por secci√≥n`);

      let manometroOK=true;
      if(tipo==="Banco"){
        if(set<=600 && ["MAN-005","MAN-006"].includes(manometro)) manometroOK=true;
        else if(set>600 && set<800 && ["MAN-002","MAN-003","MAN-005","MAN-006"].includes(manometro)) manometroOK=true;
        else if(set>=800 && ["MAN-002","MAN-003"].includes(manometro)) manometroOK=true;
        else manometroOK=false;
      }

      let aprobadoIncertidumbre=true;
      let criterio=promedio*0.01;

      if(tipo==="Banco"){
        const data=MANOMETER_DATA[manometro];
        if(!manometroOK){ aprobadoIncertidumbre=false; mensajeIncert=`‚ùå Man√≥metro no adecuado para el set indicado.`; }
        else if(!data){ aprobadoIncertidumbre=false; mensajeIncert=`‚ö†Ô∏è No hay datos de incertidumbre registrados para ${manometro}.`; try{ localStorage.removeItem(`U_${manometro}`); }catch(e){} }
        else {
          const incertidumbreGlobal=OPERATOR_DATA.length>0?desviacionEstandar(OPERATOR_DATA)/Math.sqrt(OPERATOR_DATA.length):0;
          const u_res=data.resolucion/Math.sqrt(12);
          const u_der=data.deriva/Math.sqrt(3);
          const u_interp=data.u_interp;
          const u_cert=data.certificado/data.factor_cert;
          const muestra=presiones.map(p=>Number(p.valor));
          const desvia=desviacionEstandar(muestra);
          const u_lectura=muestra.length>0?desvia/Math.sqrt(muestra.length):0;
          const u_comb=Math.sqrt(u_res**2+u_der**2+u_interp**2+u_lectura**2+u_cert**2);
          const divisorInterp=data.divisor_interp;
          const denom=(Math.pow(u_res,4)/200)+(Math.pow(u_der,4)/50)+(Math.pow(u_interp,4)/divisorInterp)+(Math.pow(u_lectura,4)/3)+(Math.pow(u_cert,4)/200);
          const v=denom>0?Math.pow(u_comb,4)/denom:NaN;
          const u_presion=Math.sqrt(u_comb**2+incertidumbreGlobal**2);
          const v_manometro_den=(Math.pow(u_comb,4)/(isFinite(v)&&v>0?v:1e-12))+(Math.pow(incertidumbreGlobal,4)/14);
          const v_manometro=v_manometro_den>0?Math.pow(u_presion,4)/v_manometro_den:NaN;
          const gl_redon=isFinite(v_manometro)?Math.floor(v_manometro):100;
          const confianza=0.9545;
          const tail=(1-confianza)/2;
          const prob=1-tail;
          let k=1.96;
          try{ const tval=tInvNumeric(prob,gl_redon); if(isFinite(tval)) k=Math.abs(tval); }catch(e){ k=1.96; }
          U=isFinite(k)?u_presion*k:null;
          if(U!==null) try{ localStorage.setItem(`U_${manometro}`,Number(U).toFixed(6)); }catch(e){}
          if(U===null) { aprobadoIncertidumbre=false; mensajeIncert=`‚ùå Error en el c√°lculo de U expandida.`; }
          else if(criterio<U){ aprobadoIncertidumbre=false; mensajeIncert=`‚ùå Incertidumbre (${U.toFixed(6)}) mayor que criterio (1%): ${criterio.toFixed(6)}`; }
          else mensajeIncert=`‚úÖ Criterio de incertidumbre ok. U expandida: ${U.toFixed(6)}. Criterio (1%): ${criterio.toFixed(6)}`;
        }
      }
      else if(["VST 2","VST 3"].includes(tipo)){
        // C√°lculo de incertidumbre VST en tiempo real
        const trans_data=TRANSMISOR_DATA[transmisor];
        const celda_data=CELDA_DATA[celdas];
        
        if(!trans_data){ aprobadoIncertidumbre=false; mensajeIncert=`‚ö†Ô∏è No hay datos de incertidumbre para transmisor ${transmisor}.`; }
        else if(!celda_data){ aprobadoIncertidumbre=false; mensajeIncert=`‚ö†Ô∏è No hay datos de incertidumbre para celda ${celdas}.`; }
        else {
          // ===== TRANSMISOR (Presi√≥n indicada) =====
          const u_res_trans=trans_data.resolucion/Math.sqrt(12);
          const u_der_trans=trans_data.deriva/Math.sqrt(3);
          const u_interp_trans=trans_data.u_interp;
          const u_cert_trans=trans_data.certificado/trans_data.factor_cert;
          // u_comb_trans es u_presion_indicada
          const u_presion_indicada_psi=Math.sqrt(u_res_trans**2+u_der_trans**2+u_interp_trans**2+u_cert_trans**2);
          
          // Grados libertad transmisor - divisor de interpolaci√≥n depende del tipo
          let divisor_trans=10;
          if(transmisor==="TP-010") divisor_trans=12;
          else if(transmisor==="TP-002" || transmisor==="TP-009") divisor_trans=11;
          else if(transmisor==="TP-008") divisor_trans=9;
          else if(transmisor==="TP-004") divisor_trans=10;
          
          const Ures4_trans=Math.pow(u_res_trans,4);
          const Uder4_trans=Math.pow(u_der_trans,4);
          const Uint4_trans=Math.pow(u_interp_trans,4);
          const Ucert4_trans=Math.pow(u_cert_trans,4);
          const Ucomb4_trans=Math.pow(u_presion_indicada_psi,4);
          const denom_trans=(Ures4_trans/200)+(Uder4_trans/50)+(Uint4_trans/divisor_trans)+(Ucert4_trans/200);
          const v_indicada=denom_trans>0?Ucomb4_trans/denom_trans:Infinity;
          
          // ===== CELDA DE CARGA (Presi√≥n generada) =====
          const u_res_celda=celda_data.resolucion/Math.sqrt(12);
          const u_der_celda=celda_data.certificado/Math.sqrt(3);
          const u_interp_celda=celda_data.u_interp;
          const u_cert_celda=celda_data.certificado/celda_data.factor_cert;
          // u_comb_celda es u_presion_generada
          const u_fuerza_kN=Math.sqrt(u_res_celda**2+u_der_celda**2+u_interp_celda**2+u_cert_celda**2);
          
          // Grados libertad celda - divisor de interpolaci√≥n depende del tipo
          let divisor_celda=11;
          if(celdas==="CEC-001") divisor_celda=11;
          else if(celdas==="CEC-004") divisor_celda=9;
          else if(celdas==="CEC-003") divisor_celda=8;
          else if(celdas==="CEC-005") divisor_celda=9;
          else if(celdas==="CEC-006") divisor_celda=9;
          else if(celdas==="CEC-007") divisor_celda=9;
          
          const Ures4_celda=Math.pow(u_res_celda,4);
          const Uder4_celda=Math.pow(u_der_celda,4);
          const Uint4_celda=Math.pow(u_interp_celda,4);
          const Ucert4_celda=Math.pow(u_cert_celda,4);
          const Ucomb4_celda=Math.pow(u_fuerza_kN,4);
          const denom_celda=(Ures4_celda/200)+(Uder4_celda/50)+(Uint4_celda/divisor_celda)+(Ucert4_celda/200);
          const v_generada=denom_celda>0?Ucomb4_celda/denom_celda:Infinity;
          
          // Convertir fuerza (kN) a presi√≥n (psi) usando √°rea
          const diamMedio=(diametro_ext+diametro_int)/2;
          const area_m2=Math.PI*Math.pow(diamMedio,2)/4;
          const area_in2=area_m2/(0.0254*0.0254);
          const factor_conversion_kN_lbf=1/0.0044482216152605;
          const u_presion_generada_psi=area_in2>0?u_fuerza_kN*factor_conversion_kN_lbf/area_in2:0;
          
          // Incertidumbre repetibilidad (desviaci√≥n est√°ndar de presiones medidas)
          const muestra_presiones=presiones.map(p=>Number(p.valor));
          const desvia_presiones=desviacionEstandar(muestra_presiones);
          const incertidumbre_repetibilidad=muestra_presiones.length>0?desvia_presiones/Math.sqrt(muestra_presiones.length):0;
          
          // Combinar componentes de incertidumbre
          const u_p_apertura_psi=Math.sqrt(u_presion_indicada_psi**2+u_presion_generada_psi**2+incertidumbre_repetibilidad**2);
          
          // Grados libertad combinado (Welch-Satterthwaite)
          let v_p_apertura=Infinity;
          const u_apertura_4=Math.pow(u_p_apertura_psi,4);
          const term_ind_4=Math.pow(u_presion_indicada_psi,4);
          const term_gen_4=Math.pow(u_presion_generada_psi,4);
          const term_rep_4=Math.pow(incertidumbre_repetibilidad,4);
          let denom_v_apertura=0;
          
          if(v_indicada!==0 && isFinite(v_indicada)) denom_v_apertura+=(term_ind_4/v_indicada);
          if(v_generada!==0 && isFinite(v_generada)) denom_v_apertura+=(term_gen_4/v_generada);
          denom_v_apertura+=(term_rep_4/2);
          
          if(denom_v_apertura>0 && isFinite(u_apertura_4)) v_p_apertura=u_apertura_4/denom_v_apertura;
          
          // Floor para grados libertad
          v_p_apertura=Math.floor(v_p_apertura);
          
          // Factor de cobertura K
          let k=1.96;
          try{
            if(isFinite(v_p_apertura) && v_p_apertura>0){
              const p=1-(1-0.9545)/2;
              const tval=tInvNumeric(p,v_p_apertura);
              if(isFinite(tval)) k=Math.abs(tval);
            }
          }catch(e){ k=1.96; }
          
          // Incertidumbre expandida
          U=isFinite(k)?u_p_apertura_psi*k:null;
          
          if(U===null){ aprobadoIncertidumbre=false; mensajeIncert=`‚ùå Error en el c√°lculo de U expandida VST.`; }
          else if(criterio<U){ aprobadoIncertidumbre=false; mensajeIncert=`‚ùå Incertidumbre (${U.toFixed(6)}) mayor que criterio (1%): ${criterio.toFixed(6)}`; }
          else mensajeIncert=`‚úÖ Criterio de incertidumbre ok. U expandida: ${U.toFixed(6)}. Criterio (1%): ${criterio.toFixed(6)}`;
        }
      }

      const aprobadoBase=erroresRep.length===0 && erroresSec.length===0;
      const aprobadoFinal=aprobadoBase && manometroOK && aprobadoIncertidumbre;

      let resultado=aprobadoFinal?"‚úÖ Aprobado":"‚ùå Repite";
      if(erroresRep.length) resultado+=`\n\n- Fall√≥ repetibilidad\n${erroresRep.join("\n")}`;
      if(erroresSec.length) resultado+=`\n\n- Fall√≥ secci√≥n\n${erroresSec.join("\n")}`;
      if(!manometroOK) resultado+=`\n\n‚ùå Man√≥metro mal seleccionado.`;
      if(!aprobadoIncertidumbre) resultado+=`\n\n${mensajeIncert}`;
      resultado+=`\n\nRango repetibilidad: ${infRep.toFixed(2)} - ${supRep.toFixed(2)} PSI\nRango por secci√≥n: ${infSeccion.toFixed(2)} - ${supSeccion.toFixed(2)} PSI`;

      mostrarMensaje(resultado);

      // Guardar presiones en localStorage
      localStorage.removeItem("datos_medidos");
      localStorage.setItem("datos_medidos",JSON.stringify({p1:Number(p1),p2:Number(p2),p3:Number(p3),p4:tipo==="Banco"?Number(p4_val):null,promedio:Number(promedio),set:Number(set),tipo}));

      // Enviar presiones seg√∫n tipo
      if(tipo==="Banco") localStorage.setItem("presiones_banco",JSON.stringify({p1,p2,p3,p4:p4_val}));
      else if(["VST 2","VST 3"].includes(tipo)) localStorage.setItem("presiones_vst",JSON.stringify({p1,p2,p3}));

      if(aprobadoFinal){
        const prueba={client_proy,tag,set,seccion,tipo,manometro:tipo==="Banco"?manometro:"N/A",presiones:presiones.map(p=>p.valor),promedio,U_expandida:U,criterio,fecha:new Date().toLocaleString()};
        const aprobadas=JSON.parse(localStorage.getItem("pruebasAprobadas"))||[];
        aprobadas.push(prueba);
        localStorage.setItem("pruebasAprobadas",JSON.stringify(aprobadas));
        document.getElementById("Tag").value=""; document.getElementById("p1").value=""; document.getElementById("p2").value=""; document.getElementById("p3").value=""; document.getElementById("p4").value="";
      }
    }

    function enviarCorreo(){
      const pruebas=JSON.parse(localStorage.getItem("pruebasAprobadas"))||[];
      if(pruebas.length===0) return alert("No hay pruebas aprobadas para enviar.");
      const contenido=pruebas.map((p,i)=>`#${i+1} - ${p.fecha}\nCliente: ${p.client_proy||"N/A"}\nTag: ${p.tag||"N/A"}\nSet: ${p.set} PSI\nSecci√≥n: ${p.seccion}\nTipo: ${p.tipo}\nMan√≥metro: ${p.manometro}\nPresiones: ${p.presiones.join(", ")}\nPromedio: ${Number(p.promedio).toFixed(2)} PSI\nU expandida: ${p.U_expandida!==null&&p.U_expandida!==undefined?Number(p.U_expandida).toFixed(6):"N/A"}\nCriterio (1%): ${Number(p.criterio).toFixed(6)}`).join("\n----------------\n");
      const params={to_name:"Valser",to_email:"tecnicodeservicios@valserindustriales.com",message:contenido};
      emailjs.send("service_vp5zw8m","template_6v8y173",params).then(()=>{ alert("üì§ Correo enviado con √©xito"); localStorage.removeItem("pruebasAprobadas"); }).catch(err=>{ console.error("EmailJS error:",err); alert("‚ùå Error al enviar el correo."); });
    }

    if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js").then(()=>console.log("SW registrado correctamente")).catch(e=>console.error("SW fall√≥",e)); }
  </script>
    <button
    onclick="window.location.href='validacion_incertidumbre_banco.html'"
        style="
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 2px 6px;
      font-size: 10px;
      opacity: 0.4;
      background: #000000;
      border: 1px solid #aaa;
      border-radius: 3px;
      transition: opacity 0.3s;
      width: auto;
    "
        onmouseover="this.style.opacity='1'"
    onmouseout="this.style.opacity='0.4'">
    ‚Üí Validaci√≥n banco

  </button>
     <button
    onclick="window.location.href='validacion_incertidumbre_VST.html'"
    style="
      position: fixed;
      bottom: 30px;
      left: 10px;
      padding: 2px 6px;
      font-size: 10px;
      opacity: 0.4;
      background: #000000;
      border: 1px solid #aaa;
      border-radius: 3px;
      transition: opacity 0.3s;
      width: auto;
    "
    onmouseover="this.style.opacity='1'"
    onmouseout="this.style.opacity='0.4'">
    ‚Üí Validaci√≥n VST
  </button>

</body>
</html>
