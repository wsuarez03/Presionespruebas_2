<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Validación de Incertidumbre VST</title>

<style>
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; color: #333; }
h1 { text-align: center; margin-bottom: 20px; }
table { width: auto; border-collapse: collapse; background: white; margin-bottom: 30px; }
td, th { border: 1px solid #ccc; padding: 10px; text-align: center; }
th { background: #e8e8e8; }
.fila-doble { display: flex;  gap: 20px;  justify-content: space-between;}
.columna {  width: 48%;}
table {  width: auto;  border-collapse: collapse;}
</style>

<!-- jStat para student t -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

</head>
<body>

<h1>Validación De Incertidumbre VST</h1>

        
        <div class="fila-doble">

            <div class="columna">
                <!-- TABLA DATOS INICIO -->
                <table id="tablainicio">
                <tr><td>Presión de set</td><td></td><td>psi</td></tr>
                <tr><td>Presión de caldera</td><td></td><td>psi</td></tr>
                <tr><td>Área</td><td></td><td>In^2</td></tr>
                <tr><td>Fuerza a realizar</td><td></td><td>Lb-f</td></tr>
                </table>
            </div>

            <div class="columna">
                <!-- TABLA EQUIPOS -->
                <table id="tablaeq">
                <tr><td>Transmisor usado</td><td></td></tr>
                <tr><td>Celda de carga usada</td><td></td></tr>
                </table>
            </div>

        </div>


       <!-- TABLA INCERTIDUMBRE-->
       <table id="tablaincertidumbre">
       <th>Factor de cobertura (K)</th>
       <th>Incertidumbre expandida (U)</th>
       <tr><td></td><td></td></tr>
       </table>
        

       <!-- TABLA Resumen incertidumbre ecuación 1-->
       <table id="tablairesumincertecua1">
       <tr><th colspan="5">Resumen incertidumbre ecuación 1</th></tr>
       <th>Magnitud</th>
       <th>Incertidumbre</th>
       <th>Coeficientes de sensibilidad</th>
       <th>Grados de libertad</th>
       <th rowspan="4">1</th>
       <tr><td>P_apertura (psi)</td><td></td><td>0</td><td></td></tr>
       <tr><td>P_indicada (psi)</td><td></td><td>1</td><td></td></tr>
       <tr><td>P_generada (psi)</td><td></td><td>1</td><td></td></tr>
       </table>

        <!-- TABLA DATOS MEDIDOS -->
        <table id="tablaDatosMedidosVST">
        <tr><th colspan="3">Incertidumbre por repetibilidad</th></tr>
        <tr><th colspan="3">Datos medidos</th></tr>
        <tr><th>N</th><th>Pm (psi)</th><th>Desviación</th></tr>
        <tr><td>1</td><td id="pm1"></td><th></th></tr>
        <tr><td>2</td><td id="pm2"></td><th>Incertidumbre</th></tr>
        <tr><td>3</td><td id="pm3"></td><th rowspan="2"></th></tr>
        <tr><td><strong>Promedio</strong></td><td id="promedio"></td></tr>
        </table>

        <!-- TABLA DATOS MEDIDOS2 -->
        <table id="tablaDatosMedidosVSTv2">
        <tr><th colspan="6">Datos medidos</th></tr>
        <th>N</th>
        <th>Pt (psi)</th>
        <th>L1 (mm)</th>
        <th>L1 (m)</th>
        <th>L2 (mm)</th>
        <th>L2 (m)</th>
        <tr><td>Promedio</td><td></td><td></td><td></td><td></td><td></td></tr>
        </table>

        <!-- TABLA ECUACIÓN 2 -->
        <table id="Datos_ecuación_2">
        <tr>
        <th>Datos ecuación 2</th>
        <th>Resolución (psi)</th>
        <th>Deriva (psi)</th>
        <th>Suma de residuos - Interpolación</th>
        <th>Certificado (psi)</th>
        <th>Factor de cobertura</th>
        </tr>
        <tr><td>Transmisor de presión VST3 - 1000 psi</td><td>0.1</td><td>0.72</td><td>0.292808052203206</td><td>0.72</td><td>2</td></tr>
        <tr><td>Transmisor de presión  VST3 - 5000 psi</td><td>0.1</td><td>1.4</td><td>0.967846419901973</td><td>1.4</td><td>2</td></tr>
        <tr><td>Transmisor de presión  VST3 - 145 psi</td><td>0.1</td><td>0.05</td><td>0.0147761347706818</td><td>0.05</td><td>2</td></tr>
        <tr><td>Transmisor de presión  VST2 - 870 psi</td><td>0.1</td><td>0.1</td><td>0.0401484588381262</td><td>0.1</td><td>2</td></tr>
        <tr><td>Transmisor de presión  VST2 - 3625 psi</td><td>0.1</td><td>0.81</td><td>0.520987754949661</td><td>0.81</td><td>2</td></tr>
        </table>

        <!-- TABLA MAGNITUD -->
        <table id="Magnitud">
        <tr>
        <th>Magnitud</th>
        <th>u resolución (psi)</th>
        <th>u deriva (psi)</th>
        <th>u Interpolación (psi)</th>
        <th>u certificado (psi)</th>
        <th>u combinada (psi)</th>
        <th>Grados de libertad</th>
        </tr>
        <tr><td>Transmisor de presión VST3 - 1000 psi</td><td></td><td></td><td>0.292808052203206</td><td></td><td></td><td></td></tr>
        <tr><td>Transmisor de presión  VST3 - 5000 psi</td><td></td><td></td><td>0.967846419901973</td><td></td><td></td><td></td></tr>
        <tr><td>Transmisor de presión  VST3 - 145 psi</td><td></td><td></td><td>0.0147761347706818</td><td></td><td></td><td></td></tr>
        <tr><td>Transmisor de presión  VST2 - 870 psi</td><td></td><td></td><td>0.0401484588381262</td><td></td><td></td><td></td></tr>
        <tr><td>Transmisor de presión  VST2 - 3625 psi</td><td></td><td></td><td>0.520987754949661</td><td></td><td></td><td></td></tr>
        </table>
                
        <!-- TABLA MAGNITUD P2-->
       <table id="tablaMagnitudp2">
       <th>u_Presión indicada (psi)</th>
       <th>Grados de libertad</th>
       <th>Coeficiente de sensibilidad</th>
       <tr><td></td><td></td><td>1</td></tr>
       </table>

        <!-- TABLA ECUACIÓN 3 -->
        <table id="Datos_ecuación_3">
        <tr>
        <th>Datos ecuación 3</th>
        <th>Resolución (kN)</th>
        <th>Deriva (kN)</th>
        <th>Interpolación (kN)</th>
        <th>Certificado (kN)</th>
        <th>Factor de cobertura</th>
        </tr>
        <tr><td>Celda de carga VST 3 - 0,5T</td><td>0.0004</td><td></td><td>0.00120499518150945</td><td></td><td>2</td></tr>
        <tr><td>Celda de carga VST 3- 1T</td><td>0.001</td><td></td><td>0.00733851478857701</td><td></td><td>2</td></tr>
        <tr><td>Celda de carga VST 3- 2T</td><td>0.001</td><td></td><td>0.0234029276640666</td><td></td><td>2</td></tr>
        <tr><td>Celda de carga VST 2- 1T</td><td>0.001</td><td></td><td>0.024671976476918</td><td></td><td>2</td></tr>
        <tr><td>Celda de carga VST 2- 2T</td><td>0.001</td><td></td><td>0.0223125119839804</td><td></td><td>2</td></tr>
        <tr><td>Celda de carga VST 2- 5T</td><td>0.04</td><td></td><td>0.0538769501113177</td><td></td><td>2</td></tr>
        </table>

        <!-- TABLA MAGNITUD 2 -->
        <table id="Magnitud2">
        <tr>
        <th>Magnitud</th>
        <th>u resolución (kN)</th>
        <th>u deriva (kN)</th>
        <th>u Interpolación (kN)</th>
        <th>u certificado (kN)</th>
        <th>u combinada (kN)</th>
        <th>Grados de libertad</th>
        </tr>
        <tr><td>Celda de carga VST 3 - 0,5T</td><td></td><td></td><td>0.00120499518150945</td><td></td><td></td><td></td></tr>
        <tr><td>Celda de carga VST 3- 1T</td><td></td><td></td><td>0.00733851478857701</td><td></td><td></td><td></td></tr>
        <tr><td>Celda de carga VST 3- 2T</td><td></td><td></td><td>0.0234029276640666</td><td></td><td></td><td></td></tr>
        <tr><td>Celda de carga VST 2- 1T</td><td></td><td></td><td>0.024671976476918</td><td></td><td></td><td></td></tr>
        <tr><td>Celda de carga VST 2- 2T</td><td></td><td></td><td>0.0223125119839804</td><td></td><td></td><td></td></tr>
        <tr><td>Celda de carga VST 2- 5T</td><td></td><td></td><td>0.0538769501113177</td><td></td><td></td><td></td></tr>
        </table>
                
        <!-- TABLA MAGNITUD2P2-->
       <table id="tablaMagnitud2p2">
       <th>Presión generada (Pg) (psi)</th>
       <th>Fuerza (Lb-f)</th>
       <th>Fuerza (kN)</th>
       <tr><td></td><td></td><td></td></tr>
       </table>
       
        <!-- TABLA MAGNITUD2P3-->
       <table id="tablaMagnitud2p3">
       <th>u_Fuerza (kN)</th>
       <th>u_Fuerza (lb-f)</th>
       <th>Grados de libertad</th>
       <th>Coeficiente de sensibilidad</th>
       <tr><td></td><td></td><td></td><td></td></tr>
       </table>

        <!-- TABLA MAGNITUD2P4-->
       <table id="tablaMagnitud2p4">
       <th>u_Presión generada (kPa)</th>
       <th>U_Presión generada (psi)</th>
       <th>Grados de libertad</th>
       <th>Coeficiente de sensibilidad</th>
       <tr><td></td><td></td><td></td><td></td></tr>
       </table>

        <!-- TABLA DATOS  INCERTIDUMBRE ECUACION 4 -->
        <table id="tablaincertidumbreecua4">
        <tr><th colspan="5">Datos e incertidumbre ecuación 4</th></tr>
        <th>Área (m^2)</th>
        <th>Área (in^2)</th>
        <th>u_Área (m^2)</th>
        <th>Grados de libertad</th>
        <th>Coeficiente de sensibilidad</th>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        </table>
               
        <!-- TABLA DATOS ECUACION 5 -->
        <table id="tablaecuacion5">
        <th>Datos ecuación 5</th>
        <th>Resolución</th>
        <th>Deriva</th>
        <th>Error no corregido</th>
        <th>Certificado</th>
        <th>Factor de cobertura (k)</th>
        <tr><td>Longitud 1</td><td>0.01</td><td>0.011</td><td>0.020</td><td>0.011</td><td>2</td></tr>
        <tr><td>Longitud 2</td><td>0.01</td><td>0.011</td><td>0.020</td><td>0.011</td><td>2</td></tr>
        </table>

        <!-- TABLA DATOS  INCERTIDUMBRE ECUACION 5 -->
        <table id="tablaincertidumbre5">
        <th>Incertidumbre ecuación 5</th>
        <th>u resolución</th>
        <th>u deriva</th>
        <th>u error no corregido</th>
        <th>u certificado</th>
        <th>u Total (mm)</th>
        <th>u combinada (m)</th>
        <th>Coeficientes de sensibilidad</th>
        <th>Grados de libertad</th>
        <tr><td>Longitud 1</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td>Longitud 2</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        </table>

               
        <!-- TABLA DATOS DIAMETRO-->
        <table id="tabladiametro">
        <th>Incertidumbre ecuación 5</th>
        <th>u resolución</th>
        <th>u deriva</th>
        <th>u error no corregido</th>
        <tr><td></td><td></td><td></td><td></td></tr>
        </table>



<script>
// ======================================
// Funciones auxiliares
// ======================================
function tInvNumeric(prob, df, tol = 1e-12, maxIter = 200) {
    if (!(prob > 0 && prob < 1) || df <= 0) return NaN;

    const sign = prob < 0.5 ? -1 : 1;
    const target = prob < 0.5 ? 1 - prob : prob;

    let lo = 0;
    let hi = 1;

    while (jStat.studentt.cdf(hi, df) < target) {
        hi *= 2;
        if (hi > 1e6) break;
    }

    for (let i = 0; i < maxIter; i++) {
        const mid = (lo + hi) / 2;
        const cdfMid = jStat.studentt.cdf(mid, df);

        if (Math.abs(cdfMid - target) < tol) return sign * mid;

        if (cdfMid < target) lo = mid;
        else hi = mid;
    }

    return sign * (lo + hi) / 2;
}

function desviacionEstandar(valores) {
    const n = valores.length;
    if (n < 2) return 0;
    const mean = valores.reduce((a,b)=>a+b,0)/n;
    const variance = valores.reduce((s,x)=>s+(x-mean)**2,0)/(n-1);
    return Math.sqrt(variance);
}

// ======================================
// PROCESO PRINCIPAL
// ======================================


document.addEventListener("DOMContentLoaded", () => {
    const datos = JSON.parse(localStorage.getItem("presiones_vst"));
    if (!datos) return;

    document.getElementById("p1").value = datos.p1;
    document.getElementById("p2").value = datos.p2;
    document.getElementById("p3").value = datos.p3;


    // Mostrar tabla
    for (let i = 0; i < 4; i++) {
        const celda = document.getElementById(`pm${i+1}`);
        celda.textContent = presiones[i] !== undefined ? presiones[i] + " PSI" : "-";
    }

    // PROMEDIO
    const promedio = presiones.length ? presiones.reduce((a,b)=>a+b,0)/presiones.length : 0;
    document.getElementById("promedio").textContent = promedio.toFixed(2) + " PSI";

    // DESVIACIÓN PARA TABLA ECUACIÓN
    const desvia = desviacionEstandar(presiones);
    const tablaDatos = document.getElementById("Datos_ecuación_1");
    for (let r=1; r<tablaDatos.rows.length; r++) {
        tablaDatos.rows[r].cells[4].textContent = desvia.toFixed(8);
    }

    // =====================================================
    // INCERTIDUMBRE OPERARIOS
    // =====================================================
    const tablaOperarios = document.getElementById("tablaIncertidumbreOperarios");
    const datosOperarios = [];

    for (let fila of tablaOperarios.rows) {
        for (let celda of fila.cells) {
            const val = parseFloat(celda.textContent.replace(",","."));
            if (!isNaN(val)) datosOperarios.push(val);
        }
    }

    const incertidumbreGlobal = datosOperarios.length
        ? desviacionEstandar(datosOperarios)/Math.sqrt(datosOperarios.length)
        : 0;

    document.getElementById("cantDatos").textContent = datosOperarios.length;
    document.getElementById("desviacion").textContent = desviacionEstandar(datosOperarios).toFixed(8);
    document.getElementById("incertidumbre").textContent = incertidumbreGlobal.toFixed(8);

    // =====================================================
    // PROCESAR TABLA MAGNITUD Y TABLA MANÓMETROS
    // =====================================================
    const tablaMagnitud = document.getElementById("Magnitud");
    const tablaManometros = document.getElementById("tablaManometros");

    for (let i = 1; i < tablaMagnitud.rows.length; i++) {

        const res = parseFloat(tablaDatos.rows[i].cells[1].textContent);
        const der = parseFloat(tablaDatos.rows[i].cells[2].textContent);
        const interp = parseFloat(tablaMagnitud.rows[i].cells[3].textContent);
        const lectura = parseFloat(tablaDatos.rows[i].cells[4].textContent);
        const certificado = parseFloat(tablaDatos.rows[i].cells[5].textContent);
        const factorCert = parseFloat(tablaDatos.rows[i].cells[6].textContent);

        const u_res = res/Math.sqrt(12);
        const u_der = der/Math.sqrt(3);
        const u_interp = interp;
        const u_lectura = lectura / Math.sqrt(presiones.length);
        const u_cert = certificado / factorCert;

        const u_comb = Math.sqrt(u_res**2 + u_der**2 + u_interp**2 + u_lectura**2 + u_cert**2);

        tablaMagnitud.rows[i].cells[1].textContent = u_res.toFixed(9);
        tablaMagnitud.rows[i].cells[2].textContent = u_der.toFixed(9);
        tablaMagnitud.rows[i].cells[4].textContent = u_lectura.toFixed(9);
        tablaMagnitud.rows[i].cells[5].textContent = u_cert.toFixed(9);
        tablaMagnitud.rows[i].cells[6].textContent = u_comb.toFixed(9);

        // GRADOS DE LIBERTAD DEL COMPONENTE
        const v = Math.pow(u_comb,4) /
                  ( (u_res**4/200) + (u_der**4/50) + (u_interp**4/10) + (u_lectura**4/3) + (u_cert**4/200) );

        tablaMagnitud.rows[i].cells[7].textContent = v.toFixed(8);

        // U presión apertura
        const u_pres = Math.sqrt(u_comb**2 + incertidumbreGlobal**2);
        tablaManometros.rows[i].cells[1].textContent = u_pres.toFixed(10);

        // GRADOS DE LIBERTAD DEL MANÓMETRO
        const v_man = Math.pow(u_pres,4) /
                      ( (u_comb**4 / v) + (incertidumbreGlobal**4 / 14) );

        const v_man_red = Math.floor(v_man);
        tablaManometros.rows[i].cells[2].textContent = v_man_red;

        // FACTOR K
        const confianza = 0.9545;
        const tail = (1-confianza)/2;
        const prob = 1 - tail;
        const k = Math.abs(tInvNumeric(prob, v_man_red));

        tablaManometros.rows[i].cells[3].textContent = k.toFixed(12);

        // U EXPANDIDA
        tablaManometros.rows[i].cells[4].textContent = (u_pres * k).toFixed(10);
    }

});
</script>

<button onclick="window.location.href='index.html'" 
    style="margin-top:20px; padding:10px 20px;">
← Volver a Verificación de Presiones
</button>

</body>
</html>
