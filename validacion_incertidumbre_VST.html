<!DOCTYPE html>
    <html lang="es">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Validación de Incertidumbre VST</title>

    <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; color: #333; }
    h1 { text-align: center; margin-bottom: 20px; }
    table { width: auto; border-collapse: collapse; background: white; margin-bottom: 30px; }
    td, th { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #e8e8e8; }
    .fila-doble { display: flex;  gap: 20px;  justify-content: space-between;}
    .columna {  width: 48%;}
    table {  width: auto;  border-collapse: collapse;}
    </style>

    <!-- jStat para student t -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

    </head>
    <body>

    <h1>Validación De Incertidumbre VST</h1>

            
            <div class="fila-doble">

                <div class="columna">
                    <!-- TABLA DATOS INICIO -->
                    <table id="tablainicio">
                    <tr><td>Presión de set</td><td id="promedio_inicio"></td><td>psi</td></tr>
                    <tr><td>Presión de caldera</td><td></td><td>psi</td></tr>
                    <tr><td>Área</td><td></td><td>In^2</td></tr>
                    <tr><td>Fuerza a realizar</td><td></td><td>Lb-f</td></tr>
                    </table>
                </div>

                <div class="columna">
                    <!-- TABLA EQUIPOS -->
                    <table id="tablaeq">
                    <tr><td>Transmisor usado</td><td id="transmisor_VST"></td></tr>
                    <tr><td>Celda de carga usada</td><td id="celda_VST"></td></tr>
                    </table>
                </div>

            </div>


        <!-- TABLA INCERTIDUMBRE-->
        <table id="tablaincertidumbre">
            <tr><th>Factor de cobertura (K)</th><th>Incertidumbre expandida (U)</th></tr>
            <tr><td></td><td></td></tr>
            <!-- aquí se añadirán filas dinámicamente -->
        </table>
            


        <!-- TABLA Resumen incertidumbre ecuación 1-->
        <table id="tablairesumincertecua1">
        <tr><th colspan="5">Resumen incertidumbre ecuación 1</th></tr>
        <tr>
            <th>Magnitud</th>
            <th>Incertidumbre</th>
            <th>Coeficientes de sensibilidad</th>
            <th>Grados de libertad</th>
            <th rowspan="4">1</th>
        </tr>
        <tr><td>P_apertura (psi)</td><td></td><td>0</td><td></td></tr>
        <tr><td>P_indicada (psi)</td><td></td><td>1</td><td></td></tr>
        <tr><td>P_generada (psi)</td><td></td><td>1</td><td></td></tr>
        </table>

            <!-- TABLA DATOS MEDIDOS -->
            <table id="tablaDatosMedidosVST">
            <tr><th colspan="3">Incertidumbre por repetibilidad</th></tr>
            <tr><th colspan="3">Datos medidos</th></tr>
            <tr><th>N</th><th>Pm (psi)</th><th>Desviación</th></tr>
            <tr><td>1</td><td id="pm1"></td><td></td></tr>
            <tr><td>2</td><td id="pm2"></td><th>Incertidumbre</th></tr>
            <tr><td>3</td><td id="pm3"></td><td rowspan="2"></td></tr>
            <tr><td><strong>Promedio</strong></td><td id="promedio_datos"></td></tr>
            </table>

            <!-- TABLA DATOS MEDIDOS2 -->
            <table id="tablaDatosMedidosVSTv2">
            <tr><th colspan="6">Datos medidos</th></tr>
            <tr>
            <th>N</th>
            <th>Pt (psi)</th>
            <th>L1 (mm)</th>
            <th>L1 (m)</th>
            <th>L2 (mm)</th>
            <th>L2 (m)</th>
            </tr>
            <tr><td>Promedio</td><td id="pres_caldera_VST"></td><td id="diametro_ext_VST"></td><td></td><td id="diametro_int_VST"></td><td></td></tr>
            </table>

            <!-- TABLA ECUACIÓN 2 -->
            <table id="Datos_ecuación_2">
            <tr>
            <th>Datos ecuación 2</th>
            <th>Resolución (psi)</th>
            <th>Deriva (psi)</th>
            <th>Suma de residuos - Interpolación</th>
            <th>Certificado (psi)</th>
            <th>Factor de cobertura</th>
            </tr>
            <tr><td>Transmisor de presión VST3 - 1000 psi</td><td>0.01</td><td>0.72</td><td>0.292808052203206</td><td>0.72</td><td>2</td></tr>
            <tr><td>Transmisor de presión  VST3 - 5000 psi</td><td>0.01</td><td>1.4</td><td>0.967846419901973</td><td>1.4</td><td>2</td></tr>
            <tr><td>Transmisor de presión  VST3 - 145 psi</td><td>0.01</td><td>0.05</td><td>0.0147761347706818</td><td>0.048</td><td>2</td></tr>
            <tr><td>Transmisor de presión  VST2 - 870 psi</td><td>0.01</td><td>0.1</td><td>0.0401484588381262</td><td>0.07</td><td>2</td></tr>
            <tr><td>Transmisor de presión  VST2 - 3625 psi</td><td>0.01</td><td>0.81</td><td>0.520987754949661</td><td>0.81</td><td>2</td></tr>
            </table>

            <!-- TABLA MAGNITUD -->
            <table id="Magnitud">
            <tr>
            <th>Magnitud</th>
            <th>u resolución (psi)</th>
            <th>u deriva (psi)</th>
            <th>u Interpolación (psi)</th>
            <th>u certificado (psi)</th>
            <th>u combinada (psi)</th>
            <th>Grados de libertad</th>
            </tr>
            <tr><td>Transmisor de presión VST3 - 1000 psi</td><td></td><td></td><td>0.292808052203206</td><td></td><td></td><td></td></tr>
            <tr><td>Transmisor de presión  VST3 - 5000 psi</td><td></td><td></td><td>0.967846419901973</td><td></td><td></td><td></td></tr>
            <tr><td>Transmisor de presión  VST3 - 145 psi</td><td></td><td></td><td>0.0147761347706818</td><td></td><td></td><td></td></tr>
            <tr><td>Transmisor de presión  VST2 - 870 psi</td><td></td><td></td><td>0.0401484588381262</td><td></td><td></td><td></td></tr>
            <tr><td>Transmisor de presión  VST2 - 3625 psi</td><td></td><td></td><td>0.520987754949661</td><td></td><td></td><td></td></tr>
            </table>
                    

                    <!-- TABLA MAGNITUD P2-->
        <table id="tablaMagnitudp2">
        <th>u_Presión indicada (psi)</th>
        <th>Grados de libertad</th>
        <th>Coeficiente de sensibilidad</th>
        <tr><td></td><td></td><td>1</td></tr>
        </table>

            <!-- TABLA ECUACIÓN 3 -->
            <table id="Datos_ecuación_3">
            <tr>
            <th>Datos ecuación 3</th>
            <th>Resolución (kN)</th>
            <th>Deriva (kN)</th>
            <th>Interpolación (kN)</th>
            <th>Certificado (kN)</th>
            <th>Factor de cobertura</th>
            </tr>
            <tr><td>Celda de carga VST 3 - 0,5T</td><td>0.0004</td><td></td><td>0.00120499518150945</td><td></td><td>2</td></tr>
            <tr><td>Celda de carga VST 3- 1T</td><td>0.001</td><td></td><td>0.00733851478857701</td><td></td><td>2</td></tr>
            <tr><td>Celda de carga VST 3- 2T</td><td>0.001</td><td></td><td>0.0234029276640666</td><td></td><td>2</td></tr>
            <tr><td>Celda de carga VST 2- 1T</td><td>0.001</td><td></td><td>0.024671976476918</td><td></td><td>2</td></tr>
            <tr><td>Celda de carga VST 2- 2T</td><td>0.001</td><td></td><td>0.0223125119839804</td><td></td><td>2</td></tr>
            <tr><td>Celda de carga VST 2- 5T</td><td>0.04</td><td></td><td>0.0538769501113177</td><td></td><td>2</td></tr>
            </table>

            <!-- TABLA MAGNITUD 2 -->
            <table id="Magnitud2">
            <tr>
            <th>Magnitud</th>
            <th>u resolución (kN)</th>
            <th>u deriva (kN)</th>
            <th>u Interpolación (kN)</th>
            <th>u certificado (kN)</th>
            <th>u combinada (kN)</th>
            <th>Grados de libertad</th>
            </tr>
            <tr><td>Celda de carga VST 3 - 0,5T</td><td></td><td></td><td>0.00120499518150945</td><td></td><td></td><td></td></tr>
            <tr><td>Celda de carga VST 3- 1T</td><td></td><td></td><td>0.00733851478857701</td><td></td><td></td><td></td></tr>
            <tr><td>Celda de carga VST 3- 2T</td><td></td><td></td><td>0.0234029276640666</td><td></td><td></td><td></td></tr>
            <tr><td>Celda de carga VST 2- 1T</td><td></td><td></td><td>0.024671976476918</td><td></td><td></td><td></td></tr>
            <tr><td>Celda de carga VST 2- 2T</td><td></td><td></td><td>0.0223125119839804</td><td></td><td></td><td></td></tr>
            <tr><td>Celda de carga VST 2- 5T</td><td></td><td></td><td>0.0538769501113177</td><td></td><td></td><td></td></tr>
            </table>
                    
            <!-- TABLA MAGNITUD2P2-->
        <table id="tablaMagnitud2p2">
        <th>Presión generada (Pg) (psi)</th>
        <th>Fuerza (Lb-f)</th>
        <th>Fuerza (kN)</th>
        <tr><td></td><td></td><td></td></tr>
        </table>
        
            <!-- TABLA MAGNITUD2P3-->
        <table id="tablaMagnitud2p3">
        <th>u_Fuerza (kN)</th>
        <th>u_Fuerza (lb-f)</th>
        <th>Grados de libertad</th>
        <th>Coeficiente de sensibilidad</th>
        <tr><td></td><td></td><td></td><td></td></tr>
        </table>

            <!-- TABLA MAGNITUD2P4-->
        <table id="tablaMagnitud2p4">
        <th>u_Presión generada (kPa)</th>
        <th>U_Presión generada (psi)</th>
        <th>Grados de libertad</th>
        <th>Coeficiente de sensibilidad</th>
        <tr><td></td><td></td><td></td><td>1</td></tr>
        </table>

            <!-- TABLA DATOS  INCERTIDUMBRE ECUACION 4 -->
            <table id="tablaincertidumbreecua4">
            <tr><th colspan="5">Datos e incertidumbre ecuación 4</th></tr>
            <th>Área (m^2)</th>
            <th>Área (in^2)</th>
            <th>u_Área (m^2)</th>
            <th>Grados de libertad</th>
            <th>Coeficiente de sensibilidad</th>
            <tr><td></td><td></td><td></td><td></td><td></td></tr>
            </table>
                
            <!-- TABLA DATOS ECUACION 5 -->
            <table id="tablaecuacion5">
            <th>Datos ecuación 5</th>
            <th>Resolución</th>
            <th>Deriva</th>
            <th>Error no corregido</th>
            <th>Certificado</th>
            <th>Factor de cobertura (k)</th>
            <tr><td>Longitud 1</td><td>0.01</td><td>0.011</td><td>0.020</td><td>0.011</td><td>2</td></tr>
            <tr><td>Longitud 2</td><td>0.01</td><td>0.011</td><td>0.020</td><td>0.011</td><td>2</td></tr>
            </table>

            <!-- TABLA DATOS  INCERTIDUMBRE ECUACION 5 -->
            <table id="tablaincertidumbre5">
            <th>Incertidumbre ecuación 5</th>
            <th>u resolución</th>
            <th>u deriva</th>
            <th>u error no corregido</th>
            <th>u certificado</th>
            <th>u Total (mm)</th>
            <th>u combinada (m)</th>
            <th>Coeficientes de sensibilidad</th>
            <th>Grados de libertad</th>
            <tr><td>Longitud 1</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr><td>Longitud 2</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            </table>

                
            <!-- TABLA DATOS DIAMETRO-->
            <table id="tabladiametro">
            <th>Diametro (m)</th>
            <th>u_ Diámetro (m)</th>
            <th>Grados de libertad</th>
            <th>Coeficientes de sensibilidad</th>
            <tr><td></td><td></td><td></td><td></td></tr>
            </table>


        
    <script>
    // ======================================
    // Funciones auxiliares
    // ======================================
    function tInvNumeric(prob, df, tol = 1e-12, maxIter = 200) {
        if (!(prob > 0 && prob < 1) || df <= 0) return NaN;
        const sign = prob < 0.5 ? -1 : 1;
        const target = prob < 0.5 ? 1 - prob : prob;
        let lo = 0;
        let hi = 1;
        while (jStat.studentt.cdf(hi, df) < target) {
            hi *= 2;
            if (hi > 1e6) break;
        }
        for (let i = 0; i < maxIter; i++) {
            const mid = (lo + hi) / 2;
            const cdfMid = jStat.studentt.cdf(mid, df);
            if (Math.abs(cdfMid - target) < tol) return sign * mid;
            if (cdfMid < target) lo = mid;
            else hi = mid;
        }
        return sign * (lo + hi) / 2;
    }

    function desviacionEstandar(valores) {
        const n = valores.length;
        if (n < 2) return 0;
        const mean = valores.reduce((a,b)=>a+b,0)/n;
        const variance = valores.reduce((s,x)=>s+(x-mean)**2,0)/(n-1);
        return Math.sqrt(variance);
    }

    // ======================================
    // MAPEO DE CÓDIGOS TP A PRESIÓN Y MODELO
    // ======================================
    const mapeoTransmisores = {
        "TP-010": { presion: "1000 psi", modelo: "VST3" },
        "TP-002": { presion: "5000 psi", modelo: "VST3" },
        "TP-004": { presion: "145 psi", modelo: "VST3" },
        "TP-008": { presion: "870 psi", modelo: "VST2" },
        "TP-009": { presion: "3625 psi", modelo: "VST2" }
    };

    // ======================================
    // MAPEO DE CÓDIGOS CEC (CELDAS) A NOMBRES DE TABLA
    // ======================================
    const mapeoCeldas = {
        "CEC-001": "Celda de carga VST 3 - 0,5T",
        "CEC-003": "Celda de carga VST 3- 2T",
        "CEC-004": "Celda de carga VST 3- 1T",
        "CEC-005": "Celda de carga VST 2- 1T",
        "CEC-006": "Celda de carga VST 2- 2T",
        "CEC-007": "Celda de carga VST 2- 5T"
    };

    // ========================================
    // Buscar fila en la tabla Magnitud
    // ========================================
    function buscarMagnitudYRellenar(codigoTransmisor) {
        // Extraer el código base (TP-XXX) eliminando paréntesis y presión
        const codigoBase = codigoTransmisor.replace(/\s*\([^)]*\)/g, '').trim();
        
        const datos = mapeoTransmisores[codigoBase];
        
        if (!datos) {
            console.warn("⚠ Código de transmisor no reconocido:", codigoTransmisor, "Base:", codigoBase);
            return;
        }

        const nombreBuscado = `Transmisor de presión ${datos.modelo} - ${datos.presion}`;

        const tabla = document.getElementById("Magnitud");
        if (!tabla) {
            console.warn("⚠ Tabla Magnitud no encontrada");
            return;
        }

        const filas = tabla.getElementsByTagName("tr");

        for (let i = 1; i < filas.length; i++) {
            const celdasn = filas[i].getElementsByTagName("td");
            if (celdasn.length > 0) {
                const nombre = celdasn[0].textContent.trim();

                // Búsqueda flexible: comparar sin espacios extras
                if (nombre.replace(/\s+/g, ' ') === nombreBuscado.replace(/\s+/g, ' ')) {
                    const uComb = celdasn[5].textContent.trim(); // u combinada
                    const grados = celdasn[6].textContent.trim(); // grados de libertad

                    console.log("✓ Transmisor encontrado en fila", i);
                    colocarEnTablaMagnitudP2(uComb, grados);
                    return;
                }
            }
        }

        console.warn("⚠ No se encontró el transmisor en la tabla Magnitud:", nombreBuscado);
    }

    // ========================================
    // Colocar valores u_comb y v en tablaMagnitudp2
    // ========================================
    function colocarEnTablaMagnitudP2(uComb, grados) {
        const tabla = document.getElementById("tablaMagnitudp2");
        if (!tabla) {
            console.warn("⚠ Tabla tablaMagnitudp2 no encontrada");
            return;
        }

        const filas = tabla.getElementsByTagName("tr");
        if (filas.length < 2) {
            console.warn("⚠ tablaMagnitudp2 no tiene filas editables");
            return;
        }

        const fila = filas[1]; // la única fila editable
        const celdasn = fila.getElementsByTagName("td");

        if (celdasn.length >= 2) {
            celdasn[0].textContent = uComb || "—";
            celdasn[1].textContent = grados || "—";
        }
    }

    // ======================================
    // PROCESO PRINCIPAL
    // ======================================

    document.addEventListener("DOMContentLoaded", () => {
        // leer datos desde localStorage (si no existen — usar guías/neutros)
        const transmisor = JSON.parse(localStorage.getItem("transmisor_VST"));
        document.getElementById("transmisor_VST").textContent = transmisor ? transmisor : "-";
        const celdas = JSON.parse(localStorage.getItem("celda_VST"));
        document.getElementById("celda_VST").textContent = celdas ? celdas : "-";
        const diametro_ext = parseFloat(JSON.parse(localStorage.getItem("diametro_ext_VST")) || 0);
        const diametro_int = parseFloat(JSON.parse(localStorage.getItem("diametro_int_VST")) || 0);
        const pres_caldera = JSON.parse(localStorage.getItem("pres_caldera_VST"));
        document.getElementById("pres_caldera_VST").textContent = pres_caldera ? pres_caldera : "-";

        document.getElementById("diametro_ext_VST").textContent = isNaN(diametro_ext) ? "-" : diametro_ext;
        document.getElementById("diametro_int_VST").textContent = isNaN(diametro_int) ? "-" : diametro_int;

        const datos = JSON.parse(localStorage.getItem("presiones_vst"));

        if (!datos) return;

        const presiones = [
            parseFloat(datos.p1) || 0,
            parseFloat(datos.p2) || 0,
            parseFloat(datos.p3) || 0
        ];

        presiones.forEach((p, i) => {
            const celda = document.getElementById(`pm${i+1}`);
            celda.textContent = (p !== undefined && !isNaN(p)) ? p + " PSI" : "-";
        });

        // PROMEDIO
        const promedio = presiones.length ? presiones.reduce((a,b)=>a+b,0)/presiones.length : 0;
        document.getElementById("promedio_inicio").textContent = promedio.toFixed(2) + " PSI";
        document.getElementById("promedio_datos").textContent = promedio.toFixed(2) + " PSI";

        // DESVIACIÓN PARA TABLA ECUACIÓN
        const desvia = desviacionEstandar(presiones);
        const tablaDato = document.getElementById("tablaDatosMedidosVST");
        // comprobar que existe la fila que queremos actualizar
        if (tablaDato && tablaDato.rows[3] && tablaDato.rows[3].cells[2]) {
            tablaDato.rows[3].cells[2].textContent = desvia.toFixed(8);
        }

        // desviación estándar dividida entre √3 (componente de repetibilidad u_lectura)
        const desviaDivRaiz3 = desvia / Math.sqrt(3);

        // colocar el valor en la celda combinada debajo de “Incertidumbre”
        if (tablaDato && tablaDato.rows[5] && tablaDato.rows[5].cells[2]) {
            tablaDato.rows[5].cells[2].textContent = desviaDivRaiz3.toFixed(8);
        }

        // convertir diámetros (si venían en mm) a metros (ejemplo: dividir entre 1000)
        const diametro_ext_1000 = isNaN(diametro_ext) ? 0 : diametro_ext/1000;
        const diametro_int_1000 = isNaN(diametro_int) ? 0 : diametro_int/1000;

        const tablaDato2 = document.getElementById("tablaDatosMedidosVSTv2");
        if (tablaDato2 && tablaDato2.rows[2]) {
            // filas/celdas de tu tabla: ajusta defensivamente
            if (tablaDato2.rows[2].cells[3]) tablaDato2.rows[2].cells[3].textContent = diametro_ext_1000.toFixed(3);
            if (tablaDato2.rows[2].cells[5]) tablaDato2.rows[2].cells[5].textContent = diametro_int_1000.toFixed(3);
        }

        // Calcular diámetro medio (m) y rellenar la tabla `tabladiametro`
        (function rellenarDiametroMedio() {
            const tablaDiam = document.getElementById("tabladiametro");
            const diamMedio = (Number(diametro_ext_1000) + Number(diametro_int_1000)) / 2;

            if (!tablaDiam) return;

            // Buscar la primera fila que contenga celdas <td> (fila de datos, "la celda de abajo")
            const filas = Array.from(tablaDiam.getElementsByTagName("tr"));
            let filaDatos = filas.find(r => r.getElementsByTagName("td").length > 0);

            if (!filaDatos) {
                // no hay fila de datos, crear una nueva al final
                if (tablaDiam.insertRow) {
                    filaDatos = tablaDiam.insertRow(-1);
                    // crear las celdas necesarias para mantener estructura
                    for (let k = 0; k < 4; k++) filaDatos.insertCell(k);
                } else {
                    return;
                }
            }

            let celdas = filaDatos.getElementsByTagName("td");
            // asegurarse de tener al menos 4 celdas (para colocar coeficiente en la 4ª)
            if (celdas.length < 4 && filaDatos.insertCell) {
                for (let m = celdas.length; m < 4; m++) filaDatos.insertCell(m);
                // refrescar colección
                celdas = filaDatos.getElementsByTagName("td");
            }

            if (celdas.length === 0) return;

            // escribir en la primera celda de la fila de datos ("la celda de abajo")
            celdas[0].textContent = isFinite(diamMedio) ? diamMedio.toFixed(6) : "—";

            // calcular coeficiente (π * diamMedio) / 2 y colocarlo en la 4ª columna
            const coefSens = (Math.PI * diamMedio) / 2;
            if (celdas.length >= 4) {
                celdas[3].textContent = isFinite(coefSens) ? coefSens.toFixed(6) : "—";
            }

            // Calcular área (m^2) = π * (diamMedio^2) / 4 y escribir en `tablaincertidumbreecua4` bajo 'Área (m^2)'
            try {
                const area = Math.PI * Math.pow(diamMedio, 2) / 4;
                const tablaArea = document.getElementById("tablaincertidumbreecua4");
                if (tablaArea) {
                    const filasA = Array.from(tablaArea.getElementsByTagName("tr"));
                    let filaArea = filasA.find(r => r.getElementsByTagName("td").length > 0);
                    if (!filaArea) {
                        if (tablaArea.insertRow) {
                            filaArea = tablaArea.insertRow(-1);
                            for (let k = 0; k < 5; k++) filaArea.insertCell(k);
                        }
                    }
                    if (filaArea) {
                        const cArea = filaArea.getElementsByTagName("td");
                        if (cArea.length > 0) cArea[0].textContent = isFinite(area) ? area.toFixed(6) : "—";
                        // convertir m^2 a in^2: 1 in = 0.0254 m -> 1 m^2 = (1/0.0254)^2 in^2
                        const areaIn2 = isFinite(area) ? area / (0.0254 * 0.0254) : NaN;
                        if (cArea.length > 1) {
                            cArea[1].textContent = isFinite(areaIn2) ? areaIn2.toFixed(6) : "—";
                        }
                    }
                }
            } catch (e) {
                console.warn('Error al calcular/escribir área:', e);
            }
        })();
        // ========================================
        // Actualizar `tablainicio`:
        // - Presión de caldera: valor traído desde localStorage
        // - Área: usar la misma que se muestra en `tablaincertidumbreecua4` (in^2)
        // - Fuerza a realizar: (Presión de set - Presión de caldera) * Área
        // ========================================
        try {
            const tablaInicio = document.getElementById("tablainicio");
            if (tablaInicio) {
                // Presión de caldera (fila 2, celda 2)
                if (tablaInicio.rows[1] && tablaInicio.rows[1].cells[1]) {
                    tablaInicio.rows[1].cells[1].textContent = pres_caldera !== null && pres_caldera !== undefined ? String(pres_caldera) : "-";
                }

                // Recalcular diámetro medio y área (in^2) localmente para asegurar coherencia
                const diamMedio_local = (Number(diametro_ext_1000) + Number(diametro_int_1000)) / 2;
                const area_m2_local = Math.PI * Math.pow(diamMedio_local, 2) / 4;
                const areaIn2_local = isFinite(area_m2_local) ? area_m2_local / (0.0254 * 0.0254) : NaN;

                // Área (fila 3, celda 2)
                if (tablaInicio.rows[2] && tablaInicio.rows[2].cells[1]) {
                    tablaInicio.rows[2].cells[1].textContent = isFinite(areaIn2_local) ? areaIn2_local.toFixed(6) + " In^2" : "-";
                }

                // Fuerza a realizar = (Presión de set - Presión de caldera) * Área (psi * in^2 = lb-f)
                const presSetNum = Number(promedio) || 0;
                const presCalNum = Number(parseFloat(pres_caldera)) || 0;
                const fuerza = isFinite(areaIn2_local) ? (presSetNum - presCalNum) * areaIn2_local : NaN;
                if (tablaInicio.rows[3] && tablaInicio.rows[3].cells[1]) {
                    tablaInicio.rows[3].cells[1].textContent = isFinite(fuerza) ? fuerza.toFixed(6) : "-";
                }
                // También colocar la Fuerza a realizar dentro de `tablaMagnitud2p2` (Lb-f y kN)
                try {
                    const tablaM2p2 = document.getElementById("tablaMagnitud2p2");
                    if (tablaM2p2) {
                        const filasM = Array.from(tablaM2p2.getElementsByTagName("tr"));
                        let filaM = filasM.find(r => r.getElementsByTagName("td").length > 0);
                        if (!filaM && tablaM2p2.insertRow) {
                            filaM = tablaM2p2.insertRow(-1);
                            for (let k = 0; k < 3; k++) filaM.insertCell(k);
                        }
                        if (filaM) {
                            const cM = filaM.getElementsByTagName("td");
                            // primera columna -> Presión generada Pg = Fuerza (Lb-f) / Área (in^2)
                            const pres_generada = (isFinite(fuerza) && isFinite(areaIn2_local) && areaIn2_local !== 0) ? (fuerza / areaIn2_local) : NaN;
                            if (cM.length > 0) cM[0].textContent = isFinite(pres_generada) ? pres_generada.toFixed(6) : "-";
                            // segunda columna -> Fuerza (Lb-f)
                            if (cM.length > 1) cM[1].textContent = isFinite(fuerza) ? fuerza.toFixed(6) : "-";
                            // tercera columna -> Fuerza (kN) (1 lbf = 0.0044482216152605 kN)
                            const fuerza_kN = isFinite(fuerza) ? fuerza * 0.0044482216152605 : NaN;
                            if (cM.length > 2) cM[2].textContent = isFinite(fuerza_kN) ? fuerza_kN.toFixed(6) : "-";
                        }
                    }
                } catch (e) {
                    console.warn('Error escribiendo en tablaMagnitud2p2:', e);
                }
            }
        } catch (err) {
            console.warn('Error actualizando tablainicio:', err);
        }
        // ========================================
        // PRIMERO: Actualizar `Datos_ecuación_3` -> columna 'Certificado (kN)' Y 'Deriva (kN)'
        // La Derivación (kN) = Certificado (kN) (mismo valor)
        // El Certificado se calcula: (0.13/100) * Fuerza(kN) para fila 1, etc.
        // ESTO DEBE EJECUTARSE ANTES QUE MAGNITUD2 LEA ESTOS VALORES
        // ========================================
        try {
            // recalcular fuerza y conversión a kN
            const diamMedio_local_2 = (Number(diametro_ext_1000) + Number(diametro_int_1000)) / 2;
            const area_m2_local_2 = Math.PI * Math.pow(diamMedio_local_2, 2) / 4;
            const areaIn2_local_2 = isFinite(area_m2_local_2) ? area_m2_local_2 / (0.0254 * 0.0254) : NaN;
            const presSetNum_2 = Number(promedio) || 0;
            const presCalNum_2 = Number(parseFloat(pres_caldera)) || 0;
            const fuerza_2 = isFinite(areaIn2_local_2) ? (presSetNum_2 - presCalNum_2) * areaIn2_local_2 : NaN;
            const fuerza_kN_2 = isFinite(fuerza_2) ? fuerza_2 * 0.0044482216152605 : NaN;

            const tablaE3 = document.getElementById("Datos_ecuación_3");
            
            if (tablaE3) {
                for (let r = 1; r < tablaE3.rows.length; r++) {
                    try {
                        const filaE3 = tablaE3.rows[r];
                        if (!filaE3) continue;
                        
                        // Calcular Certificado
                        let coef = 0.13/100;
                        if (r === 1) coef = 0.13/100;
                        else if (r >= 2 && r <= 5) coef = 0.07/100;
                        else if (r === 6) coef = 0.29/100;
                        
                        const certificadoCalc = isFinite(fuerza_kN_2) ? coef * fuerza_kN_2 : NaN;
                        const certificadoText = isFinite(certificadoCalc) ? certificadoCalc.toFixed(8) : "-";
                        
                        // Escribir en columna 4 (Certificado)
                        if (filaE3.cells[4]) {
                            filaE3.cells[4].textContent = certificadoText;
                        }
                        
                        // Escribir en columna 2 (Derivación = mismo que Certificado)
                        if (filaE3.cells[2]) {
                            filaE3.cells[2].textContent = certificadoText;
                        }
                    } catch (ee) {
                        console.warn('Error actualizando fila', r, 'de Datos_ecuación_3:', ee);
                        continue;
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando Datos_ecuación_3 certificado:', e);
        }

        const tablaMagnitud = document.getElementById("Magnitud");
        const tablaDato3 = document.getElementById("Datos_ecuación_2");

        // u_lectura no se usa en esta fórmula concreta (si en otra, házmelo saber)
        const u_lectura = desviaDivRaiz3;

        if (tablaMagnitud && tablaDato3) {
            // recorrer filas de datos (saltando la cabecera en row 0)
            for (let i = 1; i < tablaMagnitud.rows.length; i++) {
                try {
                    // leer valores de la tabla Datos_ecuación_2 (misma indexación asumida)
                    const rowDatos = tablaDato3.rows[i];
                    if (!rowDatos) continue;

                    // leer y convertir a número
                    const res = Number(parseFloat(rowDatos.cells[1].textContent)) || 0;
                    const der = Number(parseFloat(rowDatos.cells[2].textContent)) || 0;
                    const interp = Number(parseFloat(tablaMagnitud.rows[i].cells[3].textContent)) || 0;
                    const certificado = Number(parseFloat(rowDatos.cells[4].textContent)) || 0;
                    const factorCert = Number(parseFloat(rowDatos.cells[5].textContent)) || 1; // evitar división por 0

                    // componentes de incertidumbre (numéricos)
                    const u_res = res / Math.sqrt(12);          // rectangular
                    const u_der = der / Math.sqrt(3);           // triangular (si corresponde)
                    const u_interp = interp;                    // ya dada
                    const u_cert = factorCert !== 0 ? (certificado / factorCert) : 0;

                    // combinado (no incluye u_lectura aquí según tu fórmula)
                    const u_comb = Math.sqrt(u_res**2 + u_der**2 + u_interp**2 + u_cert**2);

                    // escribir en tabla Magnitud (celdas defensivas)
                    if (tablaMagnitud.rows[i].cells[1]) tablaMagnitud.rows[i].cells[1].textContent = u_res.toFixed(9);
                    if (tablaMagnitud.rows[i].cells[2]) tablaMagnitud.rows[i].cells[2].textContent = u_der.toFixed(9);
                    if (tablaMagnitud.rows[i].cells[4]) tablaMagnitud.rows[i].cells[4].textContent = u_cert.toFixed(9);
                    if (tablaMagnitud.rows[i].cells[5]) tablaMagnitud.rows[i].cells[5].textContent = u_comb.toFixed(9);

                    // GRADOS DE LIBERTAD aproximados (Welch-Satterthwaite tipo)
                    let divisorInterp = 10;
                    // condiciones que solicitaste:
                    // primera celda -> 12, segunda -> 11, tercera -> 9, cuarta -> 10, quinta -> 11
                    if (i === 1) divisorInterp = 12;
                    else if (i === 2 || i === 5) divisorInterp = 11;
                    else if (i === 3) divisorInterp = 9;
                    else divisorInterp = 10;

                    // asegurar números
                    const Ures4  = Math.pow(u_res, 4);
                    const Uder4  = Math.pow(u_der, 4);
                    const Uint4  = Math.pow(u_interp, 4);
                    const Ucert4 = Math.pow(u_cert, 4);
                    const Ucomb4 = Math.pow(u_comb, 4);

                    // denominador según tu fórmula
                    const denom = (Ures4 / 200) + (Uder4 / 50) + (Uint4 / divisorInterp) + (Ucert4 / 200);

                    // si denom es 0 -> infinito (no definido), cuidado con NaN
                    let v = (denom > 0) ? (Ucomb4 / denom) : Infinity;

                    // escribir en la columna correcta: índice 6 (0..6)
                    const colIndex = 6;
                    if (!tablaMagnitud.rows[i].cells[colIndex]) {
                        console.warn("Fila", i, "no tiene la celda esperada para grados de libertad. Asegurar estructura de tabla.");
                    } else {
                        if (!isFinite(v) || isNaN(v)) {
                            tablaMagnitud.rows[i].cells[colIndex].textContent = "∞";
                        } else {
                            tablaMagnitud.rows[i].cells[colIndex].textContent = v.toFixed(8);
                        }
                    }

                } catch (err) {
                    console.warn("error procesando fila", i, err);
                    continue;
                }
            }

            // ========================================
            // AL FINALIZAR: Buscar y rellenar tablaMagnitudp2
            // ========================================
            const transmisorGuardado = JSON.parse(localStorage.getItem("transmisor_VST"));
            if (transmisorGuardado) {
                buscarMagnitudYRellenar(transmisorGuardado);
            } else {
                console.warn("⚠ No hay transmisor guardado en localStorage");
            }
        }

        // ========================================
        // Rellenar `Magnitud2` (kN)
        // - u resolución (kN) = Resolución (kN) / sqrt(12)
        // - u deriva (kN)     = Deriva (kN) / sqrt(3)
        // - u Interpolación   = Interpolación (kN) (ya está)
        // - u certificado (kN)= Certificado (kN) / Factor de cobertura
        // - u combinada (kN)  = sqrt(u_res^2 + u_der^2 + u_interp^2 + u_cert^2)
        // ========================================
        try {
            const tablaE3 = document.getElementById("Datos_ecuación_3");
            const magn2 = document.getElementById("Magnitud2");
            if (tablaE3 && magn2) {
                // recorrer filas a partir de la primera de datos (índice 1)
                for (let r = 1; r < tablaE3.rows.length; r++) {
                    try {
                        const filaE = tablaE3.rows[r];
                        if (!filaE) continue;
                        const filaM2 = magn2.rows[r];
                        if (!filaM2) continue;

                        const res_kN = Number(parseFloat((filaE.cells[1] && filaE.cells[1].textContent) || 0)) || 0;
                        const der_kN = Number(parseFloat((filaE.cells[2] && filaE.cells[2].textContent) || 0)) || 0;
                        const interp_kN = Number(parseFloat((filaE.cells[3] && filaE.cells[3].textContent) || 0)) || 0;
                        const cert_kN = Number(parseFloat((filaE.cells[4] && filaE.cells[4].textContent) || 0)) || 0;
                        const factor = Number(parseFloat((filaE.cells[5] && filaE.cells[5].textContent) || 1)) || 1;

                        // Calcular componentes de incertidumbre
                        const u_res = res_kN / Math.sqrt(12);
                        const u_der = der_kN / Math.sqrt(3);
                        const u_interp = interp_kN; // ya proporcionado
                        const u_cert = factor !== 0 ? cert_kN / factor : 0; // cambiar NaN a 0

                        // Escribir los componentes en Magnitud2
                        if (filaM2.cells[1]) filaM2.cells[1].textContent = isFinite(u_res) ? u_res.toFixed(9) : "-";
                        if (filaM2.cells[2]) filaM2.cells[2].textContent = isFinite(u_der) ? u_der.toFixed(9) : "-";
                        if (filaM2.cells[3]) filaM2.cells[3].textContent = isFinite(u_interp) ? u_interp.toFixed(9) : "-";
                        if (filaM2.cells[4]) filaM2.cells[4].textContent = isFinite(u_cert) ? u_cert.toFixed(9) : "-";

                        // Ahora calcular u_combinada leyendo los valores RECIÉN ESCRITOS en Magnitud2
                        const u_res_val = Number(parseFloat(filaM2.cells[1].textContent)) || 0;
                        const u_der_val = Number(parseFloat(filaM2.cells[2].textContent)) || 0;
                        const u_interp_val = Number(parseFloat(filaM2.cells[3].textContent)) || 0;
                        const u_cert_val = Number(parseFloat(filaM2.cells[4].textContent)) || 0;

                        // u combinada = sqrt(u_res^2 + u_der^2 + u_interp^2 + u_cert^2)
                        const u_comb = Math.sqrt(
                            Math.pow(u_res_val, 2) +
                            Math.pow(u_der_val, 2) +
                            Math.pow(u_interp_val, 2) +
                            Math.pow(u_cert_val, 2)
                        );

                        // Escribir u_combinada en Magnitud2 (celda índice 5)
                        if (filaM2.cells[5]) filaM2.cells[5].textContent = isFinite(u_comb) ? u_comb.toFixed(9) : "-";

                        // GRADOS DE LIBERTAD para Magnitud2
                        try {
                            // divisores personalizados por fila (r=1..6)
                            let divInterp = 11; // por defecto
                            if (r === 1) divInterp = 11;
                            else if (r === 2) divInterp = 9;
                            else if (r === 3) divInterp = 8;
                            else if (r === 4) divInterp = 9;
                            else if (r === 5) divInterp = 9;
                            else if (r === 6) divInterp = 9;

                            const Ures4_m2  = Math.pow(u_res_val, 4);
                            const Uder4_m2  = Math.pow(u_der_val, 4);
                            const Uint4_m2  = Math.pow(u_interp_val, 4);
                            const Ucert4_m2 = Math.pow(u_cert_val, 4);
                            const Ucomb4_m2 = Math.pow(u_comb, 4);

                            const denom_m2 = (Ures4_m2 / 200) + (Uder4_m2 / 50) + (Uint4_m2 / divInterp) + (Ucert4_m2 / 200);
                            let v_m2 = (denom_m2 > 0 && isFinite(Ucomb4_m2)) ? (Ucomb4_m2 / denom_m2) : Infinity;

                            // escribir en la última columna (índice 6)
                            if (!filaM2.cells[6]) {
                                // crear celdas faltantes hasta índice 6
                                for (let k = filaM2.cells.length; k <= 6; k++) filaM2.insertCell(k);
                            }
                            filaM2.cells[6].textContent = (!isFinite(v_m2) || isNaN(v_m2)) ? "∞" : v_m2.toFixed(8);
                        } catch (errV) {
                            console.warn('Error calculando grados de libertad para Magnitud2 fila', r, errV);
                        }
                    } catch (eRow) {
                        console.warn('Error rellenando fila', r, 'de Magnitud2:', eRow);
                        continue;
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando Magnitud2:', e);
        }

        // ========================================
        // Rellenar `tablaMagnitud2p3` (u_Fuerza)
        // - u_Fuerza (kN) = u_combinada (kN) de Magnitud2 según celda seleccionada
        // - u_Fuerza (lb-f) = u_Fuerza (kN) / (4.448222 / 1000)
        // ========================================
        try {
            const celdaCodigoSeleccionada = JSON.parse(localStorage.getItem("celda_VST"));
            const magn2_tabla = document.getElementById("Magnitud2");
            const tablaM2p3 = document.getElementById("tablaMagnitud2p3");

            if (celdaCodigoSeleccionada && magn2_tabla && tablaM2p3) {
                // Convertir código CEC a nombre de tabla usando el mapeo
                const nombreCeldaTabla = mapeoCeldas[celdaCodigoSeleccionada];
                
                if (!nombreCeldaTabla) {
                    console.warn("⚠ Código de celda no reconocido en mapeo:", celdaCodigoSeleccionada);
                } else {

                    // Buscar la fila en Magnitud2 que coincida con el nombre mapeado
                    const filasM2 = Array.from(magn2_tabla.getElementsByTagName("tr"));
                    let u_comb_kN = null;
                    let filaEncontrada = false;

                    for (let i = 1; i < filasM2.length; i++) {
                        const celdasM2 = filasM2[i].getElementsByTagName("td");
                        if (celdasM2.length > 0) {
                            const nombreEnTabla = celdasM2[0].textContent.trim();
                            
                            // Comparar directamente (el mapeo debe garantizar exactitud)
                            if (nombreEnTabla === nombreCeldaTabla) {
                                u_comb_kN = Number(parseFloat(celdasM2[5].textContent)) || 0;
                                filaEncontrada = true;
                                break;
                            }
                        }
                    }

                    // Si la coincidencia exacta falla, intentar normalización
                    if (!filaEncontrada) {
                        const nombreNormalizado = nombreCeldaTabla.toLowerCase().replace(/\s+/g, ' ');
                        
                        for (let i = 1; i < filasM2.length; i++) {
                            const celdasM2 = filasM2[i].getElementsByTagName("td");
                            if (celdasM2.length > 0) {
                                const nombreEnTabla = celdasM2[0].textContent.trim();
                                const nombreEnTablaNormalizado = nombreEnTabla.toLowerCase().replace(/\s+/g, ' ');
                                
                                if (nombreEnTablaNormalizado === nombreNormalizado) {
                                    u_comb_kN = Number(parseFloat(celdasM2[5].textContent)) || 0;
                                    filaEncontrada = true;
                                    break;
                                }
                            }
                        }
                    }

                    // Rellenar tablaMagnitud2p3
                    if (u_comb_kN !== null && filaEncontrada) {
                        // Recalcular área (m^2) para obtener coeficiente de sensibilidad
                        const diamMedio_p3 = (Number(diametro_ext_1000) + Number(diametro_int_1000)) / 2;
                        const area_m2_p3 = Math.PI * Math.pow(diamMedio_p3, 2) / 4;
                        
                        const filasP3 = Array.from(tablaM2p3.getElementsByTagName("tr"));
                        let filaP3 = filasP3.find(r => r.getElementsByTagName("td").length > 0);
                        if (!filaP3 && tablaM2p3.insertRow) {
                            filaP3 = tablaM2p3.insertRow(-1);
                            for (let k = 0; k < 4; k++) filaP3.insertCell(k);
                        }
                        if (filaP3) {
                            const cP3 = filaP3.getElementsByTagName("td");
                            // columna 0: u_Fuerza (kN)
                            if (cP3.length > 0) {
                                cP3[0].textContent = isFinite(u_comb_kN) ? u_comb_kN.toFixed(9) : "-";
                            }
                            // columna 1: u_Fuerza (lb-f) = u_Fuerza (kN) / (4.448222 / 1000)
                            if (cP3.length > 1) {
                                const factor_conversion = 4.448222 / 1000; // kN a lb-f (1 lb-f = 0.004482216 kN)
                                const u_fuerza_lbf = isFinite(u_comb_kN) && factor_conversion !== 0 ? (u_comb_kN / factor_conversion) : NaN;
                                cP3[1].textContent = isFinite(u_fuerza_lbf) ? u_fuerza_lbf.toFixed(9) : "-";
                            }
                            // columna 2: Grados de libertad (copiar desde Magnitud2, celda índice 6)
                            if (cP3.length > 2) {
                                // Buscar de nuevo la fila en Magnitud2 para obtener los grados de libertad
                                let gradosLibertad = "-";
                                for (let i = 1; i < filasM2.length; i++) {
                                    const celdasM2 = filasM2[i].getElementsByTagName("td");
                                    if (celdasM2.length > 0) {
                                        const nombreEnTabla = celdasM2[0].textContent.trim();
                                        if (nombreEnTabla === nombreCeldaTabla) {
                                            gradosLibertad = celdasM2[6] ? celdasM2[6].textContent.trim() : "-";
                                            break;
                                        }
                                    }
                                }
                                cP3[2].textContent = gradosLibertad;
                            }
                            // columna 3: Coeficiente de sensibilidad = 1 / Área (m^2)
                            if (cP3.length > 3) {
                                const coefSens_p3 = isFinite(area_m2_p3) && area_m2_p3 !== 0 ? (1 / area_m2_p3) : NaN;
                                cP3[3].textContent = isFinite(coefSens_p3) ? coefSens_p3.toFixed(9) : "-";
                            }
                        }
                    } else {
                        console.warn("⚠ No se encontró u_combinada para la celda:", nombreCeldaTabla);
                    }
                }
            } else {
                console.warn("⚠ Falta información para rellenar tablaMagnitud2p3:", { celdaCodigoSeleccionada, magn2_tabla: !!magn2_tabla, tablaM2p3: !!tablaM2p3 });
            }
        } catch (e) {
            console.warn('Error actualizando tablaMagnitud2p3:', e);
        }

        // ========================================
        // Rellenar `tablaincertidumbre5` (Incertidumbre ecuación 5)
        // - u resolución = Resolución (tablaecuacion5) / sqrt(12)
        // - u deriva = Deriva (tablaecuacion5) / sqrt(3)
        // - u error no corregido = Error no corregido (tablaecuacion5)
        // - u certificado = Certificado (tablaecuacion5) / Factor de cobertura (k)
        // - u Total (mm) = sqrt(u_resolución^2 + u_deriva^2 + u_error^2 + u_certificado^2)
        // - u combinada (m) = u Total (mm) / 1000
        // - Coeficientes de sensibilidad = (1 + 0.0000136) / 2
        // - Grados de libertad = (u_Total^4) / ((u_res^4/200) + (u_der^4/50) + (u_error^4/200) + (u_cert^4/200))
        // ========================================
        try {
            const tablaEcu5 = document.getElementById("tablaecuacion5");
            const tablaInc5 = document.getElementById("tablaincertidumbre5");

            if (tablaEcu5 && tablaInc5) {
                // recorrer filas de datos (índice 1 y 2 para Longitud 1 y 2)
                for (let r = 1; r < Math.min(tablaEcu5.rows.length, 3); r++) {
                    try {
                        const filaEcu = tablaEcu5.rows[r];
                        const filaInc = tablaInc5.rows[r];
                        
                        if (!filaEcu || !filaInc) continue;

                        // Leer valores de tablaecuacion5
                        const resolucion = Number(parseFloat((filaEcu.cells[1] && filaEcu.cells[1].textContent) || 0)) || 0;
                        const deriva = Number(parseFloat((filaEcu.cells[2] && filaEcu.cells[2].textContent) || 0)) || 0;
                        const errorNoCorregido = Number(parseFloat((filaEcu.cells[3] && filaEcu.cells[3].textContent) || 0)) || 0;
                        const certificado = Number(parseFloat((filaEcu.cells[4] && filaEcu.cells[4].textContent) || 0)) || 0;
                        const factorCobertura = Number(parseFloat((filaEcu.cells[5] && filaEcu.cells[5].textContent) || 1)) || 1;

                        // Calcular componentes de incertidumbre
                        const u_resolucion = resolucion / Math.sqrt(12);
                        const u_deriva = deriva / Math.sqrt(3);
                        const u_errorNoCorregido = errorNoCorregido;
                        const u_certificado = factorCobertura !== 0 ? (certificado / factorCobertura) : 0;

                        // Escribir en tablaincertidumbre5
                        // Columna 1: u resolución
                        if (filaInc.cells[1]) filaInc.cells[1].textContent = isFinite(u_resolucion) ? u_resolucion.toFixed(9) : "-";
                        
                        // Columna 2: u deriva
                        if (filaInc.cells[2]) filaInc.cells[2].textContent = isFinite(u_deriva) ? u_deriva.toFixed(9) : "-";
                        
                        // Columna 3: u error no corregido
                        if (filaInc.cells[3]) filaInc.cells[3].textContent = isFinite(u_errorNoCorregido) ? u_errorNoCorregido.toFixed(9) : "-";
                        
                        // Columna 4: u certificado
                        if (filaInc.cells[4]) filaInc.cells[4].textContent = isFinite(u_certificado) ? u_certificado.toFixed(9) : "-";

                        // Columna 5: u Total (mm) = sqrt(u_res^2 + u_der^2 + u_error^2 + u_cert^2)
                        const u_total_mm = Math.sqrt(
                            Math.pow(u_resolucion, 2) +
                            Math.pow(u_deriva, 2) +
                            Math.pow(u_errorNoCorregido, 2) +
                            Math.pow(u_certificado, 2)
                        );
                        if (filaInc.cells[5]) filaInc.cells[5].textContent = isFinite(u_total_mm) ? u_total_mm.toFixed(9) : "-";

                        // Columna 6: u combinada (m) = u Total (mm) / 1000
                        const u_combinada_m = u_total_mm / 1000;
                        if (filaInc.cells[6]) filaInc.cells[6].textContent = isFinite(u_combinada_m) ? u_combinada_m.toFixed(9) : "-";

                        // Columna 7: Coeficientes de sensibilidad = (1 + 0.0000136) / 2
                        const coefSensibilidad = (1 + 0.0000136) / 2;
                        if (filaInc.cells[7]) filaInc.cells[7].textContent = isFinite(coefSensibilidad) ? coefSensibilidad.toFixed(9) : "-";

                        // Columna 8: Grados de libertad (Welch-Satterthwaite)
                        // v = (u_total^4) / ((u_res^4/200) + (u_der^4/50) + (u_error^4/200) + (u_cert^4/200))
                        const u_total_4 = Math.pow(u_total_mm, 4);
                        const u_res_4 = Math.pow(u_resolucion, 4);
                        const u_der_4 = Math.pow(u_deriva, 4);
                        const u_error_4 = Math.pow(u_errorNoCorregido, 4);
                        const u_cert_4 = Math.pow(u_certificado, 4);

                        const denom_grados = (u_res_4 / 200) + (u_der_4 / 50) + (u_error_4 / 200) + (u_cert_4 / 200);
                        let v_grados = (denom_grados > 0 && isFinite(u_total_4)) ? (u_total_4 / denom_grados) : Infinity;

                        if (filaInc.cells[8]) filaInc.cells[8].textContent = (!isFinite(v_grados) || isNaN(v_grados)) ? "∞" : v_grados.toFixed(8);

                    } catch (ee) {
                        console.warn('Error actualizando fila', r, 'de tablaincertidumbre5:', ee);
                        continue;
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando tablaincertidumbre5:', e);
        }

        // ========================================
        // Rellenar `tabladiametro` -> u_ Diámetro (m), Grados de libertad, Coeficientes de sensibilidad
        // Fórmula u_Diámetro (m): sqrt((u_combinada_m_fila1 * coef_sens_fila1)^2 + (u_combinada_m_fila2 * coef_sens_fila2)^2)
        // Fórmula Coeficientes de sensibilidad: (PI() * Diámetro (m)) / 2
        // Fórmula Grados de libertad: (u_Diámetro^4) / ((((u_comb_m_fila1*coef_sens_fila1)^4)/v_fila1) + (((u_comb_m_fila2*coef_sens_fila2)^4)/v_fila2))
        // ========================================
        try {
            const tablaInc5_diametro = document.getElementById("tablaincertidumbre5");
            const tablaDiam_final = document.getElementById("tabladiametro");

            if (tablaInc5_diametro && tablaDiam_final) {
                // Extraer valores de tablaincertidumbre5 para ambas filas de Longitud
                let u_diametro_componentes = [];
                let datos_filas = []; // para guardar datos por fila

                // Leer filas 1 y 2 (Longitud 1 y Longitud 2)
                for (let r = 1; r < Math.min(tablaInc5_diametro.rows.length, 3); r++) {
                    try {
                        const filaInc5 = tablaInc5_diametro.rows[r];
                        if (!filaInc5) continue;

                        // Columna 6: u combinada (m)
                        const u_combinada_m_valor = Number(parseFloat((filaInc5.cells[6] && filaInc5.cells[6].textContent) || 0)) || 0;
                        
                        // Columna 7: Coeficientes de sensibilidad
                        const coef_sens_valor = Number(parseFloat((filaInc5.cells[7] && filaInc5.cells[7].textContent) || 0)) || 0;

                        // Columna 8: Grados de libertad
                        const v_valor_texto = (filaInc5.cells[8] && filaInc5.cells[8].textContent) || "∞";
                        const v_valor = v_valor_texto === "∞" ? Infinity : Number(parseFloat(v_valor_texto)) || 0;

                        // Producto: u_combinada_m * coef_sens
                        const producto = u_combinada_m_valor * coef_sens_valor;
                        u_diametro_componentes.push(producto);
                        
                        // Guardar datos por fila para el cálculo de grados de libertad
                        datos_filas.push({
                            u_comb_m: u_combinada_m_valor,
                            coef_sens: coef_sens_valor,
                            v_fila: v_valor
                        });

                    } catch (ee) {
                        console.warn('Error leyendo fila', r, 'de tablaincertidumbre5 para diámetro:', ee);
                        u_diametro_componentes.push(0);
                        datos_filas.push({ u_comb_m: 0, coef_sens: 0, v_fila: 0 });
                    }
                }

                // Calcular u_Diámetro (m) = sqrt(suma de cuadrados)
                let u_diametro_m = 0;
                if (u_diametro_componentes.length > 0) {
                    const suma_cuadrados = u_diametro_componentes.reduce((sum, comp) => sum + Math.pow(comp, 2), 0);
                    u_diametro_m = Math.sqrt(suma_cuadrados);
                }

                // Obtener diámetro medio (m) para cálculo de coeficiente de sensibilidad
                const diamMedio_final = (Number(diametro_ext_1000) + Number(diametro_int_1000)) / 2;
                
                // Calcular Coeficientes de sensibilidad = (π * Diámetro) / 2
                const coef_sensibilidad_diam = (Math.PI * diamMedio_final) / 2;

                // Calcular Grados de libertad (Welch-Satterthwaite)
                // v = (u_Diámetro^4) / ((((u_comb_m_fila1*coef_sens_fila1)^4)/v_fila1) + (((u_comb_m_fila2*coef_sens_fila2)^4)/v_fila2))
                let v_diametro = Infinity;
                try {
                    const u_diam_4 = Math.pow(u_diametro_m, 4);
                    let denom_v = 0;

                    for (let i = 0; i < datos_filas.length; i++) {
                        const producto_fila = datos_filas[i].u_comb_m * datos_filas[i].coef_sens;
                        const producto_fila_4 = Math.pow(producto_fila, 4);
                        const v_fila = datos_filas[i].v_fila;

                        // Evitar división por cero o infinito
                        if (v_fila !== 0 && isFinite(v_fila)) {
                            denom_v += (producto_fila_4 / v_fila);
                        }
                    }

                    if (denom_v > 0 && isFinite(u_diam_4)) {
                        v_diametro = u_diam_4 / denom_v;
                    }
                } catch (ee) {
                    console.warn('Error calculando grados de libertad para diámetro:', ee);
                    v_diametro = Infinity;
                }

                // Escribir en tabladiametro
                const filasD = Array.from(tablaDiam_final.getElementsByTagName("tr"));
                let filaDatos_diametro = filasD.find(r => r.getElementsByTagName("td").length > 0);
                
                if (!filaDatos_diametro && tablaDiam_final.insertRow) {
                    filaDatos_diametro = tablaDiam_final.insertRow(-1);
                    for (let k = 0; k < 4; k++) filaDatos_diametro.insertCell(k);
                }

                if (filaDatos_diametro) {
                    const celdas_diametro = filaDatos_diametro.getElementsByTagName("td");
                    
                    // Columna 0: Diámetro (m) - ya estaba escrito, mantener
                    // (no modificar)
                    
                    // Columna 1: u_ Diámetro (m)
                    if (celdas_diametro.length > 1) {
                        celdas_diametro[1].textContent = isFinite(u_diametro_m) ? u_diametro_m.toFixed(9) : "-";
                    }
                    
                    // Columna 2: Grados de libertad
                    if (celdas_diametro.length > 2) {
                        celdas_diametro[2].textContent = (!isFinite(v_diametro) || isNaN(v_diametro)) ? "∞" : v_diametro.toFixed(8);
                    }
                    
                    // Columna 3: Coeficientes de sensibilidad
                    if (celdas_diametro.length > 3) {
                        celdas_diametro[3].textContent = isFinite(coef_sensibilidad_diam) ? coef_sensibilidad_diam.toFixed(9) : "-";
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando tabladiametro:', e);
        }

        // ========================================
        // Rellenar `tablaincertidumbreecua4` -> u_Área (m^2) y Grados de libertad
        // Fórmula u_Área: u_Área (m^2) = RAIZ((u_Diámetro (m) * Coeficientes de sensibilidad)^2)
        // Fórmula Grados de libertad: v = (u_Área^4) / ((u_Diámetro * Coef_sens)^4 / v_diámetro)
        // ========================================
        try {
            const tablaDiam_fuente = document.getElementById("tabladiametro");
            const tablaArea_destino = document.getElementById("tablaincertidumbreecua4");

            if (tablaDiam_fuente && tablaArea_destino) {
                // Leer valores de tabladiametro
                const filasDiam = Array.from(tablaDiam_fuente.getElementsByTagName("tr"));
                let filaDiam_datos = filasDiam.find(r => r.getElementsByTagName("td").length > 0);

                if (filaDiam_datos) {
                    const celdasDiam = filaDiam_datos.getElementsByTagName("td");
                    
                    // Columna 1: u_ Diámetro (m)
                    const u_diametro_valor = Number(parseFloat((celdasDiam[1] && celdasDiam[1].textContent) || 0)) || 0;
                    
                    // Columna 2: Grados de libertad de tabladiametro
                    const v_diametro_texto = (celdasDiam[2] && celdasDiam[2].textContent) || "∞";
                    const v_diametro_valor = v_diametro_texto === "∞" ? Infinity : Number(parseFloat(v_diametro_texto)) || 0;
                    
                    // Columna 3: Coeficientes de sensibilidad
                    const coef_sensibilidad_valor = Number(parseFloat((celdasDiam[3] && celdasDiam[3].textContent) || 0)) || 0;

                    // Calcular u_Área (m^2) = sqrt((u_Diámetro * Coef_sens)^2) = |u_Diámetro * Coef_sens|
                    const producto = u_diametro_valor * coef_sensibilidad_valor;
                    const u_area_m2 = Math.abs(producto);

                    // Calcular Grados de libertad (Welch-Satterthwaite)
                    // v = (u_Área^4) / ((u_Diámetro * Coef_sens)^4 / v_diámetro)
                    let v_area = Infinity;
                    try {
                        const u_area_4 = Math.pow(u_area_m2, 4);
                        const producto_4 = Math.pow(producto, 4);
                        
                        // Evitar división por cero o infinito
                        if (v_diametro_valor !== 0 && isFinite(v_diametro_valor)) {
                            const denominador = producto_4 / v_diametro_valor;
                            if (denominador > 0 && isFinite(u_area_4)) {
                                v_area = u_area_4 / denominador;
                            }
                        }
                    } catch (ee) {
                        console.warn('Error calculando grados de libertad para área:', ee);
                        v_area = Infinity;
                    }

                    // Escribir en tablaincertidumbreecua4
                    const filasArea = Array.from(tablaArea_destino.getElementsByTagName("tr"));
                    let filaArea_datos = filasArea.find(r => r.getElementsByTagName("td").length > 0);

                    if (!filaArea_datos && tablaArea_destino.insertRow) {
                        filaArea_datos = tablaArea_destino.insertRow(-1);
                        for (let k = 0; k < 5; k++) filaArea_datos.insertCell(k);
                    }

                    if (filaArea_datos) {
                        const celdas_area = filaArea_datos.getElementsByTagName("td");
                        // Intentar leer Área (m^2) desde la tabla si ya existe, si no usar cálculo por diámetro
                        let area_m2_val = NaN;
                        if (celdas_area.length > 0) {
                            const a0 = parseFloat((celdas_area[0] && celdas_area[0].textContent) || "");
                            if (!isNaN(a0) && isFinite(a0)) area_m2_val = a0;
                        }
                        if (!isFinite(area_m2_val)) {
                            // calcular desde diámetros
                            const diamMedio_paraArea = (Number(diametro_ext_1000) + Number(diametro_int_1000)) / 2;
                            area_m2_val = Math.PI * Math.pow(diamMedio_paraArea, 2) / 4;
                        }

                        // Columna 2: u_Área (m^2)
                        if (celdas_area.length > 2) {
                            celdas_area[2].textContent = isFinite(u_area_m2) ? u_area_m2.toFixed(9) : "-";
                        }
                        // Columna 3: Grados de libertad
                        if (celdas_area.length > 3) {
                            celdas_area[3].textContent = (!isFinite(v_area) || isNaN(v_area)) ? "∞" : v_area.toFixed(8);
                        }

                        // Columna 4: Coeficiente de sensibilidad = -Fuerza(kN)/(Área(m^2)^2)
                        if (celdas_area.length > 4) {
                            try {
                                const areaIn2_val = isFinite(area_m2_val) ? (area_m2_val / (0.0254 * 0.0254)) : NaN;
                                const presSetNum_local = Number(promedio) || 0;
                                const presCalNum_local = Number(parseFloat(pres_caldera)) || 0;
                                const fuerza_lbf_val = isFinite(areaIn2_val) && areaIn2_val !== 0 ? (presSetNum_local - presCalNum_local) * areaIn2_val : NaN;
                                const fuerza_kN_val = isFinite(fuerza_lbf_val) ? fuerza_lbf_val * 0.0044482216152605 : NaN;

                                const coef_from_area = (isFinite(fuerza_kN_val) && isFinite(area_m2_val) && area_m2_val !== 0)
                                    ? (-fuerza_kN_val / Math.pow(area_m2_val, 2))
                                    : NaN;

                                celdas_area[4].textContent = isFinite(coef_from_area) ? coef_from_area.toFixed(9) : "-";
                            } catch (ee) {
                                celdas_area[4].textContent = "-";
                            }
                        }
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando tablaincertidumbreecua4:', e);
        }

        // ========================================
        // Rellenar `tablaMagnitud2p4` (u_Presión generada)
        // Fórmula: u_Presión generada (kPa) = sqrt((u_Fuerza(kN) * coef_sens_p3)^2 + (u_Área(m^2) * coef_sens_area)^2)
        // Fórmula: U_Presión generada (psi) = u_Presión (kPa) / 6.894757
        // ========================================
        try {
            const tablaM2p3_src = document.getElementById("tablaMagnitud2p3");
            const tablaArea_src = document.getElementById("tablaincertidumbreecua4");
            const tablaM2p4_dst = document.getElementById("tablaMagnitud2p4");

            if (tablaM2p3_src && tablaArea_src && tablaM2p4_dst) {
                // Leer u_Fuerza (kN) y coeficiente de tablaMagnitud2p3
                const filasM2p3 = Array.from(tablaM2p3_src.getElementsByTagName("tr"));
                const filaM2p3 = filasM2p3.find(r => r.getElementsByTagName("td").length > 0);

                // Leer u_Área (m^2) y coeficiente de tablaincertidumbreecua4
                const filasArea = Array.from(tablaArea_src.getElementsByTagName("tr"));
                const filaArea = filasArea.find(r => r.getElementsByTagName("td").length > 0);

                if (filaM2p3 && filaArea) {
                    const celdasM2p3 = filaM2p3.getElementsByTagName("td");
                    const celdasArea = filaArea.getElementsByTagName("td");

                    // Leer u_Fuerza (kN) de tablaMagnitud2p3 columna 0
                    const u_fuerza_kN = Number(parseFloat((celdasM2p3[0] && celdasM2p3[0].textContent) || 0)) || 0;

                    // Leer Coeficiente de sensibilidad de tablaMagnitud2p3 columna 3
                    const coef_sens_p3 = Number(parseFloat((celdasM2p3[3] && celdasM2p3[3].textContent) || 0)) || 0;

                    // Leer u_Área (m^2) de tablaincertidumbreecua4 columna 2
                    const u_area_m2 = Number(parseFloat((celdasArea[2] && celdasArea[2].textContent) || 0)) || 0;

                    // Leer Coeficiente de sensibilidad de tablaincertidumbreecua4 columna 4
                    const coef_sens_area = Number(parseFloat((celdasArea[4] && celdasArea[4].textContent) || 0)) || 0;

                    // Calcular u_Presión (kPa) = sqrt((u_Fuerza * coef_p3)^2 + (u_Área * coef_area)^2)
                    const term1 = u_fuerza_kN * coef_sens_p3;
                    const term2 = u_area_m2 * coef_sens_area;
                    const u_presion_kpa = Math.sqrt(Math.pow(term1, 2) + Math.pow(term2, 2));

                    // Calcular U_Presión (psi) = u_Presión (kPa) / 6.894757
                    const u_presion_psi = isFinite(u_presion_kpa) ? (u_presion_kpa / 6.894757) : NaN;

                    // Leer Grados de libertad de tablaMagnitud2p3 (columna 2)
                    const v_p3_texto = (celdasM2p3[2] && celdasM2p3[2].textContent) || "∞";
                    const v_p3 = v_p3_texto === "∞" ? Infinity : Number(parseFloat(v_p3_texto)) || 0;

                    // Leer Grados de libertad de tablaincertidumbreecua4 (columna 3)
                    const v_area_texto = (celdasArea[3] && celdasArea[3].textContent) || "∞";
                    const v_area = v_area_texto === "∞" ? Infinity : Number(parseFloat(v_area_texto)) || 0;

                    // Calcular Grados de libertad (Welch-Satterthwaite)
                    // v = (u_Presión^4) / ((term1^4 / v_p3) + (term2^4 / v_area))
                    let v_presion = Infinity;
                    try {
                        const u_presion_4 = Math.pow(u_presion_kpa, 4);
                        const term1_4 = Math.pow(term1, 4);
                        const term2_4 = Math.pow(term2, 4);

                        let denom_v = 0;
                        if (v_p3 !== 0 && isFinite(v_p3)) {
                            denom_v += (term1_4 / v_p3);
                        }
                        if (v_area !== 0 && isFinite(v_area)) {
                            denom_v += (term2_4 / v_area);
                        }

                        if (denom_v > 0 && isFinite(u_presion_4)) {
                            v_presion = u_presion_4 / denom_v;
                        }
                    } catch (ee) {
                        console.warn('Error calculando grados de libertad para presión:', ee);
                        v_presion = Infinity;
                    }

                    // Escribir en tablaMagnitud2p4
                    const filasM2p4 = Array.from(tablaM2p4_dst.getElementsByTagName("tr"));
                    let filaM2p4 = filasM2p4.find(r => r.getElementsByTagName("td").length > 0);

                    if (!filaM2p4 && tablaM2p4_dst.insertRow) {
                        filaM2p4 = tablaM2p4_dst.insertRow(-1);
                        for (let k = 0; k < 4; k++) filaM2p4.insertCell(k);
                    }

                    if (filaM2p4) {
                        const celdasM2p4 = filaM2p4.getElementsByTagName("td");
                        // Columna 0: u_Presión generada (kPa)
                        if (celdasM2p4.length > 0) {
                            celdasM2p4[0].textContent = isFinite(u_presion_kpa) ? u_presion_kpa.toFixed(9) : "-";
                        }
                        // Columna 1: U_Presión generada (psi)
                        if (celdasM2p4.length > 1) {
                            celdasM2p4[1].textContent = isFinite(u_presion_psi) ? u_presion_psi.toFixed(9) : "-";
                        }
                        // Columna 2: Grados de libertad
                        if (celdasM2p4.length > 2) {
                            celdasM2p4[2].textContent = (!isFinite(v_presion) || isNaN(v_presion)) ? "∞" : v_presion.toFixed(8);
                        }
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando tablaMagnitud2p4:', e);
        }

        // ========================================
        // Rellenar `tablairesumincertecua1` (Resumen incertidumbre ecuación 1)
        // Fórmula: Incertidumbre P_apertura (psi) = sqrt(
        //   (u_Presión_indicada * coef_sensibilidad_indicada)^2 + 
        //   (U_Presión_generada * coef_sensibilidad_generada)^2 + 
        //   (incertidumbre_tablaDatosMedidosVST)^2
        // )
        // Fórmula Grados de libertad P_apertura:
        // v = (u_P_apertura^4) / ( ((u_ind * coef_ind)^4 / v_ind) + ((u_gen * coef_gen)^4 / v_gen) + (u_rep^4 / 2) )
        // ========================================
        try {
            const tablaiResumEcua1 = document.getElementById("tablairesumincertecua1");
            const tablaMagnitudp2_src = document.getElementById("tablaMagnitudp2");
            const tablaMagnitud2p4_src = document.getElementById("tablaMagnitud2p4");
            const tablaDatosMedidos_src = document.getElementById("tablaDatosMedidosVST");

            if (tablaiResumEcua1 && tablaMagnitudp2_src && tablaMagnitud2p4_src && tablaDatosMedidos_src) {
                // Leer u_Presión indicada (psi) y coeficiente de sensibilidad de tablaMagnitudp2
                const filasMagp2 = Array.from(tablaMagnitudp2_src.getElementsByTagName("tr"));
                const filaMagp2 = filasMagp2.find(r => r.getElementsByTagName("td").length > 0);

                // Leer U_Presión generada (psi) de tablaMagnitud2p4
                const filasM2p4_src = Array.from(tablaMagnitud2p4_src.getElementsByTagName("tr"));
                const filaM2p4_src = filasM2p4_src.find(r => r.getElementsByTagName("td").length > 0);

                // Leer incertidumbre de tablaDatosMedidosVST (fila 5, celda 2)
                const incertidumbre_repetibilidad = Number(parseFloat((tablaDatosMedidos_src.rows[5] && tablaDatosMedidos_src.rows[5].cells[2] && tablaDatosMedidos_src.rows[5].cells[2].textContent) || 0)) || 0;

                if (filaMagp2 && filaM2p4_src) {
                    const celdasMagp2 = filaMagp2.getElementsByTagName("td");
                    const celdasM2p4_src = filaM2p4_src.getElementsByTagName("td");

                    // Leer u_Presión indicada (psi) de tablaMagnitudp2 columna 0
                    const u_presion_indicada_psi = Number(parseFloat((celdasMagp2[0] && celdasMagp2[0].textContent) || 0)) || 0;

                    // Leer Coeficiente de sensibilidad de tablaMagnitudp2 columna 2 (coef_sensibilidad_indicada = 1)
                    const coef_sens_indicada = Number(parseFloat((celdasMagp2[2] && celdasMagp2[2].textContent) || 1)) || 1;

                    // Leer Grados de libertad de tablaMagnitudp2 (columna 1)
                    const v_indicada_texto = (celdasMagp2[1] && celdasMagp2[1].textContent) || "∞";
                    const v_indicada = v_indicada_texto === "∞" ? Infinity : Number(parseFloat(v_indicada_texto)) || 0;

                    // Leer U_Presión generada (psi) de tablaMagnitud2p4 columna 1
                    const u_presion_generada_psi = Number(parseFloat((celdasM2p4_src[1] && celdasM2p4_src[1].textContent) || 0)) || 0;

                    // El coeficiente de sensibilidad para P_generada es 1 (según la estructura de tablairesumincertecua1)
                    const coef_sens_generada = 1;

                    // Leer Grados de libertad de tablaMagnitud2p4 (columna 2)
                    const v_generada_texto = (celdasM2p4_src[2] && celdasM2p4_src[2].textContent) || "∞";
                    const v_generada = v_generada_texto === "∞" ? Infinity : Number(parseFloat(v_generada_texto)) || 0;

                    // Calcular Incertidumbre P_apertura (psi) usando Welch-Satterthwaite
                    // = sqrt((u_Presión_indicada * coef_sens_indicada)^2 + (u_Presión_generada * coef_sens_generada)^2 + (incertidumbre_repetibilidad)^2)
                    const term_indicada = u_presion_indicada_psi * coef_sens_indicada;
                    const term_generada = u_presion_generada_psi * coef_sens_generada;
                    
                    const u_p_apertura_psi = Math.sqrt(
                        Math.pow(term_indicada, 2) + 
                        Math.pow(term_generada, 2) + 
                        Math.pow(incertidumbre_repetibilidad, 2)
                    );

                    // Calcular Grados de libertad P_apertura usando Welch-Satterthwaite
                    // v = (u_P_apertura^4) / ( ((u_ind * coef_ind)^4 / v_ind) + ((u_gen * coef_gen)^4 / v_gen) + (u_rep^4 / 2) )
                    let v_p_apertura = Infinity;
                    try {
                        const u_apertura_4 = Math.pow(u_p_apertura_psi, 4);
                        const term_indicada_4 = Math.pow(term_indicada, 4);
                        const term_generada_4 = Math.pow(term_generada, 4);
                        const term_rep_4 = Math.pow(incertidumbre_repetibilidad, 4);

                        let denom_v_apertura = 0;
                        
                        // Componente de P_indicada
                        if (v_indicada !== 0 && isFinite(v_indicada)) {
                            denom_v_apertura += (term_indicada_4 / v_indicada);
                        }
                        
                        // Componente de P_generada
                        if (v_generada !== 0 && isFinite(v_generada)) {
                            denom_v_apertura += (term_generada_4 / v_generada);
                        }
                        
                        // Componente de repetibilidad (divisor = 2)
                        denom_v_apertura += (term_rep_4 / 2);

                        if (denom_v_apertura > 0 && isFinite(u_apertura_4)) {
                            v_p_apertura = u_apertura_4 / denom_v_apertura;
                        }
                    } catch (errV) {
                        console.warn('Error calculando grados de libertad para P_apertura:', errV);
                        v_p_apertura = Infinity;
                    }

                    // Escribir en tablairesumincertecua1
                    // Estructura: 
                    // Fila 0: headers
                    // Fila 1: headers
                    // Fila 2: P_apertura
                    // Fila 3: P_indicada
                    // Fila 4: P_generada
                    
                    const filaiResumEcua1 = tablaiResumEcua1.rows[2]; // fila P_apertura
                    if (filaiResumEcua1) {
                        const celdasResumEcua1 = filaiResumEcua1.getElementsByTagName("td");
                        // Columna 1: Incertidumbre P_apertura (psi)
                        if (celdasResumEcua1.length > 1) {
                            celdasResumEcua1[1].textContent = isFinite(u_p_apertura_psi) ? u_p_apertura_psi.toFixed(9) : "-";
                        }
                        // Columna 3: Grados de libertad P_apertura
                        if (celdasResumEcua1.length > 3) {
                            celdasResumEcua1[3].textContent = (!isFinite(v_p_apertura) || isNaN(v_p_apertura)) ? "∞" : v_p_apertura.toFixed(8);
                        }
                    }

                    // También rellenar filas de P_indicada y P_generada en la tabla de resumen
                    const fila_indicada = tablaiResumEcua1.rows[3];
                    if (fila_indicada) {
                        const celdasIndicada = fila_indicada.getElementsByTagName("td");
                        if (celdasIndicada.length > 1) {
                            celdasIndicada[1].textContent = isFinite(u_presion_indicada_psi) ? u_presion_indicada_psi.toFixed(9) : "-";
                        }
                        // Grados de libertad P_indicada (columna 3)
                        if (celdasIndicada.length > 3) {
                            celdasIndicada[3].textContent = (!isFinite(v_indicada) || isNaN(v_indicada)) ? "∞" : v_indicada.toFixed(8);
                        }
                    }

                    const fila_generada = tablaiResumEcua1.rows[4];
                    if (fila_generada) {
                        const celdasGenerada = fila_generada.getElementsByTagName("td");
                        if (celdasGenerada.length > 1) {
                            celdasGenerada[1].textContent = isFinite(u_presion_generada_psi) ? u_presion_generada_psi.toFixed(9) : "-";
                        }
                        // Grados de libertad P_generada (columna 3)
                        if (celdasGenerada.length > 3) {
                            celdasGenerada[3].textContent = (!isFinite(v_generada) || isNaN(v_generada)) ? "∞" : v_generada.toFixed(8);
                        }
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando tablairesumincertecua1:', e);
        }

        // ========================================
        // Rellenar `tablaincertidumbre` (Factor de cobertura e Incertidumbre expandida)
        // Fórmula: K = DISTR.T.INV(1-0.9545, v_P_apertura)
        // Fórmula: U = Incertidumbre de P_apertura * K
        // ========================================
        try {
            const tablaIncertidumbre = document.getElementById("tablaincertidumbre");
            const tablaiResumEcua1_src = document.getElementById("tablairesumincertecua1");

            if (tablaIncertidumbre && tablaiResumEcua1_src) {
                // Leer Incertidumbre P_apertura y Grados de libertad de tablairesumincertecua1
                const filaiResum = tablaiResumEcua1_src.rows[2]; // fila P_apertura

                if (filaiResum) {
                    const celdasiResum = filaiResum.getElementsByTagName("td");

                    // Leer Incertidumbre P_apertura (columna 1)
                    const u_p_apertura = Number(parseFloat((celdasiResum[1] && celdasiResum[1].textContent) || 0)) || 0;

                    // Leer Grados de libertad P_apertura (columna 3)
                    const v_p_apertura_texto = (celdasiResum[3] && celdasiResum[3].textContent) || "∞";
                    let v_p_apertura = v_p_apertura_texto === "∞" ? Infinity : Number(parseFloat(v_p_apertura_texto)) || 0;
                    
                    // Redondear grados de libertad al menor más cercano (floor)
                    if (isFinite(v_p_apertura)) {
                        v_p_apertura = Math.floor(v_p_apertura);
                    }

                    // Calcular K = DISTR.T.INV(1-0.9545, v_P_apertura)
                    // En jStat: jStat.studentt.inv(p, df) donde p es el nivel de confianza acumulado
                    // DISTR.T.INV(1-0.9545, df) = jStat.studentt.inv((1 + 0.9545)/2, df)
                    // porque es de dos colas: (1 - confianza)/2 en cada cola
                    // Para 95.45% de confianza: (1 - 0.9545)/2 = 0.02275 en cada cola
                    // Entonces p = 1 - 0.02275 = 0.97725
                    let K = NaN;
                    try {
                        if (isFinite(v_p_apertura) && v_p_apertura > 0) {
                            const p = 1 - (1 - 0.9545) / 2; // = 0.97725 para distribución de dos colas
                            K = Math.abs(jStat.studentt.inv(p, v_p_apertura));
                        } else if (!isFinite(v_p_apertura)) {
                            // Para infinitos grados de libertad, usar distribución normal
                            // DISTR.T.INV con v→∞ converge a distribución normal
                            // Para 95.45% de confianza, K ≈ 2 (aprox. normal: 1.96)
                            K = 2.0;
                        }
                    } catch (errK) {
                        console.warn('Error calculando K (Factor de cobertura):', errK);
                        K = NaN;
                    }

                    // Calcular Incertidumbre expandida U = u_P_apertura * K
                    const U = isFinite(u_p_apertura) && isFinite(K) ? (u_p_apertura * K) : NaN;

                    // Guardar U expandida en localStorage para usar en index.html
                    if (isFinite(U)) {
                        try {
                            localStorage.setItem("U_expandida_VST", U.toFixed(9));
                        } catch (e) {
                            console.warn("Error guardando U_expandida_VST:", e);
                        }
                    }

                    // Escribir en tablaincertidumbre (fila 1, índice 1)
                    const filaIncert = tablaIncertidumbre.rows[1];
                    if (filaIncert) {
                        const celdasIncert = filaIncert.getElementsByTagName("td");
                        
                        // Columna 0: Factor de cobertura (K)
                        if (celdasIncert.length > 0) {
                            celdasIncert[0].textContent = isFinite(K) ? K.toFixed(9) : "-";
                        }
                        
                        // Columna 1: Incertidumbre expandida (U)
                        if (celdasIncert.length > 1) {
                            celdasIncert[1].textContent = isFinite(U) ? U.toFixed(9) : "-";
                        }
                    }
                }
            }
        } catch (e) {
            console.warn('Error actualizando tablaincertidumbre:', e);
        }

    });
    </script>


    <button onclick="window.location.href='index.html'" 
        style="margin-top:20px; padding:10px 20px;">
    ← Volver a Verificación de Presiones
    </button>

    </body>
    </html>
